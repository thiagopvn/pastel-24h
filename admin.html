<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Administrativo - Pastelaria 24h</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="src/css/style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Após as outras importações do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#FFF7ED',
                            100: '#FFEDD5',
                            200: '#FED7AA',
                            300: '#FDBA74',
                            400: '#FB923C',
                            500: '#F97316',
                            600: '#EA580C',
                            700: '#C2410C',
                            800: '#9A3412',
                            900: '#7C2D12',
                        },
                        success: {
                            50: '#F0FDF4',
                            100: '#DCFCE7',
                            200: '#BBF7D0',
                            300: '#86EFAC',
                            400: '#4ADE80',
                            500: '#22C55E',
                            600: '#16A34A',
                            700: '#15803D',
                            800: '#166534',
                            900: '#14532D',
                        },
                        danger: {
                            50: '#FEF2F2',
                            100: '#FEE2E2',
                            200: '#FECACA',
                            300: '#FCA5A5',
                            400: '#F87171',
                            500: '#EF4444',
                            600: '#DC2626',
                            700: '#B91C1C',
                            800: '#991B1B',
                            900: '#7F1D1D',
                        },
                        warning: {
                            50: '#FFFBEB',
                            100: '#FEF3C7',
                            200: '#FDE68A',
                            300: '#FCD34D',
                            400: '#FBBF24',
                            500: '#F59E0B',
                            600: '#D97706',
                            700: '#B45309',
                            800: '#92400E',
                            900: '#78350F',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'slide-in': 'slideIn 0.3s ease-out',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'bounce-in': 'bounceIn 0.5s ease-out',
                        'pulse-slow': 'pulse 3s ease-in-out infinite',
                    },
                    keyframes: {
                        slideIn: {
                            '0%': { transform: 'translateX(100%)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(-10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        bounceIn: {
                            '0%': { transform: 'scale(0.8)', opacity: '0' },
                            '50%': { transform: 'scale(1.05)', opacity: '0.8' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #FFF7ED 0%, #FED7AA 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .kpi-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .toast {
            transition: all 0.3s ease-in-out;
        }
        
        .toast.show {
            animation: slide-in 0.3s ease-out;
        }
        
        .table-row-hover:hover {
            background: rgba(249, 115, 22, 0.05);
        }
        
        .severity-critical {
            border-left: 4px solid #DC2626;
            background: linear-gradient(90deg, #FEF2F2 0%, #FFFFFF 100%);
        }
        
        .severity-warning {
            border-left: 4px solid #F59E0B;
            background: linear-gradient(90deg, #FFFBEB 0%, #FFFFFF 100%);
        }
        
        .severity-info {
            border-left: 4px solid #3B82F6;
            background: linear-gradient(90deg, #EFF6FF 0%, #FFFFFF 100%);
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 15px;
            width: 2px;
            height: 100%;
            background: linear-gradient(to bottom, #F97316, #EA580C);
        }
        
        .timeline-dot {
            position: relative;
            z-index: 10;
        }
        
        .filter-chip {
            transition: all 0.2s ease;
        }
        
        .filter-chip.active {
            background: linear-gradient(135deg, #F97316 0%, #EA580C 100%);
            color: white;
            transform: scale(1.05);
        }
        
        .modal-backdrop {
            backdrop-filter: blur(4px);
            background: rgba(0, 0, 0, 0.4);
        }
        
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #F97316;
            border-radius: 10px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #EA580C;
        }

        /* Estilos para a seção de preços */
        .price-card {
            position: relative;
            overflow: hidden;
        }

        .price-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #F97316, #EA580C, #D97706, #F59E0B);
            border-radius: 12px;
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s ease;
        }

        .price-card:hover::before {
            opacity: 0.1;
        }

        .price-card:focus-within::before {
            opacity: 0.2;
        }

        /* Animação de destaque para cards modificados */
        .price-card.modified {
            animation: highlight-pulse 2s ease-in-out;
        }

        @keyframes highlight-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); box-shadow: 0 8px 25px rgba(249, 115, 22, 0.3); }
            100% { transform: scale(1); }
        }

        /* Grid responsivo para cards de preços */
        .prices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            padding: 1rem 0;
        }

        @media (max-width: 768px) {
            .prices-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
    
    <header class="bg-gradient-to-r from-primary-800 to-primary-600 text-white shadow-2xl sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <i class="fas fa-chart-line text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Dashboard Administrativo</h1>
                        <p class="text-primary-100 text-sm">Pastelaria 24h</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="hidden md:flex items-center space-x-2 bg-white bg-opacity-10 rounded-full px-3 py-1">
                        <div class="w-2 h-2 bg-success-400 rounded-full animate-pulse"></div>
                        <span class="text-sm">Online</span>
                    </div>
                    
                    <div class="flex items-center space-x-2 bg-white bg-opacity-10 rounded-full px-3 py-1">
                        <i class="fas fa-user-shield"></i>
                        <span id="loggedInUserName" class="font-medium">Admin</span>
                    </div>
                    
                    <button id="logoutButton" class="flex items-center bg-danger-600 hover:bg-danger-700 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        <span class="hidden md:inline">Sair</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6 space-y-6">
        <!-- Navegação por Abas -->
        <div class="glass-effect rounded-2xl p-4">
            <nav class="flex flex-wrap justify-center md:justify-start gap-2">
                <button id="btnTabDashboard" class="tab-button active px-6 py-3 bg-primary-500 text-white font-semibold rounded-lg shadow-lg hover:bg-primary-600 transition-all flex items-center">
                    <i class="fas fa-chart-pie mr-2"></i>Dashboard
                </button>
                <button id="btnTabPrecos" class="tab-button px-6 py-3 bg-gray-200 text-gray-700 font-medium rounded-lg shadow hover:bg-gray-300 transition-all flex items-center">
                    <i class="fas fa-tags mr-2"></i>Preços
                </button>
                <button id="btnTabUsuarios" class="tab-button px-6 py-3 bg-gray-200 text-gray-700 font-medium rounded-lg shadow hover:bg-gray-300 transition-all flex items-center">
                    <i class="fas fa-users mr-2"></i>Usuários
                </button>
               <button id="btnFechamento" onclick="window.location.pathname='/fechamento'" class="tab-button px-6 py-3 bg-gray-200 text-gray-700 font-medium rounded-lg shadow hover:bg-gray-300 transition-all flex items-center">
                    <i class="fas fa-calculator mr-2"></i>Fechamento
                </button>
                <button id="btnTabCaixaControle" class="tab-button px-6 py-3 bg-gray-200 text-gray-700 font-medium rounded-lg shadow hover:bg-gray-300 transition-all flex items-center">
                    <i class="fas fa-cash-register mr-2"></i>Controle de Caixa
                </button>
            </nav>
        </div>

<div id="tabContentCaixaControle" class="tab-content hidden">
    <div class="glass-effect rounded-2xl p-8">
        <!-- Header da seção -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-primary-500 to-primary-600 rounded-full mb-4 shadow-lg">
                <i class="fas fa-cash-register text-white text-2xl"></i>
            </div>
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Controle de Caixa</h2>
            <p class="text-gray-600 max-w-2xl mx-auto">
                Configure os valores padrões para o caixa inicial dos turnos. Estes valores serão aplicados automaticamente ao abrir um novo turno.
            </p>
        </div>
        
        <form id="formCaixaControle" class="space-y-8">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h3 class="text-lg font-semibold text-primary-700 mb-4 border-b pb-2">Valores Padrão do Caixa</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="defaultCaixaDinheiro" class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-money-bill-wave mr-1"></i>Valor Padrão - Dinheiro
                        </label>
                        <input type="text" id="defaultCaixaDinheiro" name="defaultCaixaDinheiro" 
                               class="w-full p-3 border border-gray-300 rounded-lg shadow-inner focus:ring-primary-500 focus:border-primary-500 input-focus" 
                               placeholder="R$ 0,00">
                        <p class="mt-1 text-sm text-gray-500">Valor em cédulas para iniciar os turnos</p>
                    </div>
                    
                    <div>
                        <label for="defaultCaixaMoedas" class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-coins mr-1"></i>Valor Padrão - Moedas
                        </label>
                        <input type="text" id="defaultCaixaMoedas" name="defaultCaixaMoedas" 
                               class="w-full p-3 border border-gray-300 rounded-lg shadow-inner focus:ring-primary-500 focus:border-primary-500 input-focus" 
                               placeholder="R$ 0,00">
                        <p class="mt-1 text-sm text-gray-500">Valor em moedas para iniciar os turnos</p>
                    </div>
                </div>
                
                <!-- ... resto do conteúdo da aba ... -->
                
                <div class="mt-6 flex justify-end">
                    <button type="submit" class="px-6 py-3 bg-primary-500 hover:bg-primary-600 text-white font-bold rounded-lg shadow-md transition-all duration-300 flex items-center">
                        <i class="fas fa-save mr-2"></i>Salvar Valores Padrão
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

        <!-- Conteúdo Dashboard -->
        <div id="tabContentDashboard" class="tab-content space-y-6">
            <!-- Seletor de Período e Filtros -->
            <div class="glass-effect rounded-2xl p-6">
                <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center">
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Filtros e Período</h3>
                        <div class="flex flex-wrap gap-2 mb-4">
                            <button class="filter-chip active px-4 py-2 rounded-full text-sm font-medium bg-gray-100 hover:bg-gray-200 transition-all" data-period="today">
                                Hoje
                            </button>
                            <button class="filter-chip px-4 py-2 rounded-full text-sm font-medium bg-gray-100 hover:bg-gray-200 transition-all" data-period="yesterday">
                                Ontem
                            </button>
                            <button class="filter-chip px-4 py-2 rounded-full text-sm font-medium bg-gray-100 hover:bg-gray-200 transition-all" data-period="week">
                                Esta Semana
                            </button>
                            <button class="filter-chip px-4 py-2 rounded-full text-sm font-medium bg-gray-100 hover:bg-gray-200 transition-all" data-period="month">
                                Este Mês
                            </button>
                            <button class="filter-chip px-4 py-2 rounded-full text-sm font-medium bg-gray-100 hover:bg-gray-200 transition-all" data-period="custom">
                                <i class="fas fa-calendar-alt mr-1"></i>Personalizado
                            </button>
                        </div>
                        
                        <div id="customDateRange" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Data Inicial</label>
                                <input type="date" id="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Data Final</label>
                                <input type="date" id="endDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div class="flex items-end">
                                <button id="applyCustomRange" class="w-full bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-lg transition-all">
                                    <i class="fas fa-search mr-2"></i>Aplicar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-2">
                        <select id="filterTurno" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            <option value="">Todos os Turnos</option>
                            <option value="Manhã">Manhã</option>
                            <option value="Tarde">Tarde</option>
                            <option value="Noite">Noite</option>
                        </select>
                        
                        <select id="filterPagamento" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            <option value="">Todas as Formas</option>
                            <option value="dinheiro">Dinheiro</option>
                            <option value="pixManual">PIX Manual</option>
                            <option value="stoneDCV">Stone D/C/V</option>
                            <option value="stoneVoucher">Stone Voucher</option>
                            <option value="pagbankDCV">PagBank D/C/V</option>
                        </select>
                        
                        <button id="refreshData" class="bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-sync-alt" id="refreshIcon"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
                <div class="kpi-card glass-effect rounded-2xl p-6 cursor-pointer" data-kpi="vendas">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Vendas Brutas</p>
                            <p id="kpiVendas" class="text-2xl font-bold text-primary-600">R$ 0,00</p>
                            <p class="text-xs text-gray-500 mt-1">
                                <span id="kpiVendasTrend" class="inline-flex items-center">
                                    <i class="fas fa-arrow-up text-success-500 mr-1"></i>
                                    <span>0%</span>
                                </span>
                            </p>
                        </div>
                        <div class="w-12 h-12 bg-primary-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-chart-line text-primary-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="kpi-card glass-effect rounded-2xl p-6 cursor-pointer" data-kpi="ticket">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Ticket Médio</p>
                            <p id="kpiTicket" class="text-2xl font-bold text-success-600">R$ 0,00</p>
                            <p class="text-xs text-gray-500 mt-1">
                                <span id="kpiTicketTrend" class="inline-flex items-center">
                                    <i class="fas fa-arrow-up text-success-500 mr-1"></i>
                                    <span>0%</span>
                                </span>
                            </p>
                        </div>
                        <div class="w-12 h-12 bg-success-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-receipt text-success-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="kpi-card glass-effect rounded-2xl p-6 cursor-pointer" data-kpi="pedidos">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total Pedidos</p>
                            <p id="kpiPedidos" class="text-2xl font-bold text-blue-600">0</p>
                            <p class="text-xs text-gray-500 mt-1">
                                <span id="kpiPedidosTrend" class="inline-flex items-center">
                                    <i class="fas fa-arrow-up text-success-500 mr-1"></i>
                                    <span>0%</span>
                                </span>
                            </p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-shopping-cart text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="kpi-card glass-effect rounded-2xl p-6 cursor-pointer" data-kpi="divergencias">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">% Divergências</p>
                            <p id="kpiDivergencias" class="text-2xl font-bold text-warning-600">0%</p>
                            <p class="text-xs text-gray-500 mt-1">
                                <span id="kpiDivergenciasTrend" class="inline-flex items-center">
                                    <i class="fas fa-arrow-down text-success-500 mr-1"></i>
                                    <span>0%</span>
                                </span>
                            </p>
                        </div>
                        <div class="w-12 h-12 bg-warning-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-warning-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="kpi-card glass-effect rounded-2xl p-6 cursor-pointer" data-kpi="caixa">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Caixa Atual</p>
                            <p id="kpiCaixa" class="text-2xl font-bold text-purple-600">R$ 0,00</p>
                            <p class="text-xs text-gray-500 mt-1">
                                <span id="kpiCaixaTrend" class="inline-flex items-center">
                                    <i class="fas fa-circle text-success-500 mr-1"></i>
                                    <span>Atualizado</span>
                                </span>
                            </p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-cash-register text-purple-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="kpi-card glass-effect rounded-2xl p-6 cursor-pointer" data-kpi="lucro">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Lucro Estimado</p>
                            <p id="kpiLucro" class="text-2xl font-bold text-green-600">R$ 0,00</p>
                            <p class="text-xs text-gray-500 mt-1">
                                <span id="kpiLucroTrend" class="inline-flex items-center">
                                    <i class="fas fa-arrow-up text-success-500 mr-1"></i>
                                    <span>0%</span>
                                </span>
                            </p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-chart-pie text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráficos -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-effect rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Vendas por Forma de Pagamento</h3>
                        <button class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-expand-alt"></i>
                        </button>
                    </div>
                    <div class="chart-container">
                        <canvas id="paymentChart"></canvas>
                    </div>
                </div>

                <div class="glass-effect rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Top 10 Produtos</h3>
                        <button class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-expand-alt"></i>
                        </button>
                    </div>
                    <div class="chart-container">
                        <canvas id="productsChart"></canvas>
                    </div>
                </div>

                <div class="glass-effect rounded-2xl p-6 lg:col-span-2">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Vendas por Horário</h3>
                        <div class="flex items-center space-x-2">
                            <select id="salesHoursPeriod" class="px-3 py-1 border border-gray-300 rounded text-sm">
                                <option value="today">Hoje</option>
                                <option value="week">Esta Semana</option>
                                <option value="month">Este Mês</option>
                            </select>
                            <button class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-expand-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="salesHoursChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Widgets de Alertas e Turnos -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Alertas e Divergências -->
                <div class="glass-effect rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Alertas & Divergências</h3>
                        <div class="flex items-center space-x-2">
                            <span class="bg-danger-100 text-danger-800 text-xs font-medium px-2 py-1 rounded-full" id="alertsCount">0</span>
                            <button id="clearAllAlerts" class="text-gray-500 hover:text-gray-700 text-sm">
                                <i class="fas fa-broom mr-1"></i>Limpar
                            </button>
                        </div>
                    </div>
                    <div id="alertsContainer" class="space-y-3 max-h-80 overflow-y-auto scrollbar-thin">
                        <div class="flex items-center justify-center py-8 text-gray-500">
                            <div class="text-center">
                                <i class="fas fa-check-circle text-3xl mb-2 text-success-500"></i>
                                <p>Nenhum alerta no momento</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Widget de Turnos -->
                <div class="glass-effect rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Status dos Turnos</h3>
                        <button id="refreshTurnos" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div id="turnosContainer" class="space-y-3 max-h-80 overflow-y-auto scrollbar-thin">
                        <!-- Turnos serão inseridos aqui -->
                    </div>
                </div>
            </div>

            <!-- Timeline de Ações -->
            <div class="glass-effect rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Timeline de Ações</h3>
                    <div class="flex items-center space-x-2">
                        <input type="text" placeholder="Buscar ações..." id="timelineSearch" class="px-3 py-1 border border-gray-300 rounded text-sm w-40">
                        <button id="exportTimeline" class="bg-primary-500 hover:bg-primary-600 text-white px-3 py-1 rounded text-sm">
                            <i class="fas fa-download mr-1"></i>Exportar
                        </button>
                    </div>
                </div>
                <div id="timelineContainer" class="space-y-4 max-h-96 overflow-y-auto scrollbar-thin relative">
                    <!-- Timeline será inserida aqui -->
                </div>
            </div>
        </div>

        <!-- Conteúdo Preços -->
        <div id="tabContentPrecos" class="tab-content hidden">
            <div class="glass-effect rounded-2xl p-8">
                <!-- Header da seção -->
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-primary-500 to-primary-600 rounded-full mb-4 shadow-lg">
                        <i class="fas fa-tags text-white text-2xl"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Gerenciar Preços dos Produtos</h2>
                    <p class="text-gray-600 max-w-2xl mx-auto">
                        Configure os preços de todos os produtos do sistema. As alterações serão aplicadas imediatamente após salvar.
                    </p>
                </div>
                
                <form id="formPrecos" class="space-y-10">
                    <!-- Pastéis -->
                    <fieldset class="price-fieldset border border-gray-200 p-8 rounded-2xl shadow-sm hover:shadow-md transition-all duration-300">
                        <legend class="text-xl font-bold text-primary-700 px-4 bg-white flex items-center">
                            <div class="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-utensils text-primary-600"></i>
                            </div>
                            Pastéis
                        </legend>
                        <div class="mt-6">
                            <div class="flex items-center justify-between mb-4">
                                <p class="text-gray-600">Configure os preços dos pastéis disponíveis no cardápio</p>
                                <span class="px-3 py-1 bg-primary-100 text-primary-700 rounded-full text-sm font-medium">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    <span id="pasteisCount">0</span> itens
                                </span>
                            </div>
                            <div id="precosPasteisContainer" class="prices-grid">
                                <!-- Cards de preços serão inseridos aqui pelo JavaScript -->
                                <div class="text-center p-8 text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Carregando preços...</p>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Casquinhas -->
                    <fieldset class="price-fieldset border border-gray-200 p-8 rounded-2xl shadow-sm hover:shadow-md transition-all duration-300">
                        <legend class="text-xl font-bold text-primary-700 px-4 bg-white flex items-center">
                            <div class="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-ice-cream text-primary-600"></i>
                            </div>
                            Casquinhas
                        </legend>
                        <div class="mt-6">
                            <div class="flex items-center justify-between mb-4">
                                <p class="text-gray-600">Configure os preços das casquinhas e sorvetes</p>
                                <span class="px-3 py-1 bg-primary-100 text-primary-700 rounded-full text-sm font-medium">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    <span id="casquinhasCount">0</span> itens
                                </span>
                            </div>
                            <div id="precosCasquinhasContainer" class="prices-grid">
                                <div class="text-center p-8 text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Carregando preços...</p>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Caldo de Cana -->
                    <fieldset class="price-fieldset border border-gray-200 p-8 rounded-2xl shadow-sm hover:shadow-md transition-all duration-300">
                        <legend class="text-xl font-bold text-primary-700 px-4 bg-white flex items-center">
                            <div class="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-glass-whiskey text-primary-600"></i>
                            </div>
                            Caldo de Cana
                        </legend>
                        <div class="mt-6">
                            <div class="flex items-center justify-between mb-4">
                                <p class="text-gray-600">Configure os preços do caldo de cana em diferentes tamanhos</p>
                                <span class="px-3 py-1 bg-primary-100 text-primary-700 rounded-full text-sm font-medium">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    <span id="caldocanaCount">0</span> itens
                                </span>
                            </div>
                            <div id="precosCaldoCanaContainer" class="prices-grid">
                                <div class="text-center p-8 text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Carregando preços...</p>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Refrigerantes e Bebidas -->
                    <fieldset class="price-fieldset border border-gray-200 p-8 rounded-2xl shadow-sm hover:shadow-md transition-all duration-300">
                        <legend class="text-xl font-bold text-primary-700 px-4 bg-white flex items-center">
                            <div class="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-bottle-water text-primary-600"></i>
                            </div>
                            Refrigerantes e Bebidas
                        </legend>
                        <div class="mt-6">
                            <div class="flex items-center justify-between mb-4">
                                <p class="text-gray-600">Configure os preços dos refrigerantes, sucos e águas</p>
                                <span class="px-3 py-1 bg-primary-100 text-primary-700 rounded-full text-sm font-medium">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    <span id="refrigerantesCount">0</span> itens
                                </span>
                            </div>
                            <div id="precosRefrigerantesContainer" class="prices-grid">
                                <div class="text-center p-8 text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Carregando preços...</p>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                    
                    <!-- Gelo -->
                    <fieldset class="price-fieldset border border-gray-200 p-8 rounded-2xl shadow-sm hover:shadow-md transition-all duration-300">
                        <legend class="text-xl font-bold text-primary-700 px-4 bg-white flex items-center">
                            <div class="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-cube text-primary-600"></i>
                            </div>
                            Gelo
                        </legend>
                        <div class="mt-6">
                            <div class="flex items-center justify-between mb-4">
                                <p class="text-gray-600">Configure o preço do gelo vendido por pacote</p>
                                <span class="px-3 py-1 bg-primary-100 text-primary-700 rounded-full text-sm font-medium">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    <span id="geloCount">0</span> itens
                                </span>
                            </div>
                            <div id="precosGeloContainer" class="prices-grid">
                                <div class="text-center p-8 text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Carregando preços...</p>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Botões de ação -->
                    <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-8 rounded-2xl border border-gray-200">
                        <div class="flex flex-col lg:flex-row gap-4 justify-between items-center">
                            <div class="text-center lg:text-left">
                                <h3 class="text-lg font-semibold text-gray-800 mb-1">Pronto para salvar?</h3>
                                <p class="text-gray-600 text-sm">
                                    Revise todos os preços antes de confirmar. As alterações serão aplicadas imediatamente.
                                </p>
                            </div>
                            <div class="flex gap-3">
                                <button type="button" id="resetPricesBtn" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg transition-all duration-300 flex items-center">
                                    <i class="fas fa-undo mr-2"></i>
                                    Resetar Alterações
                                </button>
                                <button type="submit" class="save-prices-btn px-8 py-3 bg-gradient-to-r from-success-500 to-success-600 text-white font-bold rounded-lg text-lg shadow-lg transition-all duration-300 flex items-center hover:scale-105">
                                    <i class="fas fa-save mr-2"></i>
                                    <span>Salvar Alterações nos Preços</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Status de salvamento -->
                        <div id="precosSalvosMsg" class="mt-4 text-center hidden">
                            <div class="inline-flex items-center px-4 py-2 bg-success-100 text-success-800 rounded-full text-sm font-medium">
                                <i class="fas fa-check-circle mr-2"></i>
                                <span>Preços salvos com sucesso!</span>
                            </div>
                        </div>
                        
                        <div id="precosErrorMsg" class="mt-4 text-center hidden">
                            <div class="inline-flex items-center px-4 py-2 bg-danger-100 text-danger-800 rounded-full text-sm font-medium">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                <span>Erro ao salvar preços. Tente novamente.</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

      <!-- Substitua o conteúdo de tabContentUsuarios por este HTML melhorado -->
<div id="tabContentUsuarios" class="tab-content hidden">
    <div class="glass-effect rounded-2xl p-6">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-primary-500 to-primary-600 rounded-full mb-4 shadow-lg">
                <i class="fas fa-users text-white text-2xl"></i>
            </div>
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Gerenciar Usuários</h2>
            <p class="text-gray-600 max-w-2xl mx-auto">
                Adicione, edite ou remova usuários do sistema. Configure suas permissões de acesso.
            </p>
        </div>
        
        <!-- Controles e Filtros -->
        <div class="mb-6 flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between bg-gray-50 p-4 rounded-lg">
            <!-- Busca -->
            <div class="relative flex-1 max-w-md">
                <input type="text" 
                       id="filterUsers" 
                       placeholder="Buscar por nome, email ou ID..." 
                       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                <span id="userSearchCount" class="absolute right-3 top-3 text-sm text-gray-500"></span>
            </div>
            
            <!-- Ações -->
            <div class="flex items-center gap-3">
                <!-- Toggle inativos -->
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="toggleInactiveUsers" class="mr-2">
                    <span class="text-sm text-gray-700">Mostrar inativos</span>
                </label>
                
                <!-- Botão refresh -->
                <button id="refreshUsers" 
                        class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-all flex items-center">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Atualizar
                </button>
                
                <!-- Ordenação -->
                <div class="relative group">
                    <button class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-all flex items-center">
                        <i class="fas fa-sort mr-2"></i>
                        Ordenar
                    </button>
                    <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg hidden group-hover:block z-10">
                        <button data-sort="name" data-order="asc" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center justify-between">
                            <span>Por Nome</span>
                            <i class="fas fa-sort-up text-gray-400"></i>
                        </button>
                        <button data-sort="email" data-order="asc" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center justify-between">
                            <span>Por Email</span>
                            <i class="fas fa-sort-up text-gray-400"></i>
                        </button>
                        <button data-sort="role" data-order="asc" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center justify-between">
                            <span>Por Função</span>
                            <i class="fas fa-sort-up text-gray-400"></i>
                        </button>
                        <button data-sort="date" data-order="desc" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center justify-between">
                            <span>Por Data</span>
                            <i class="fas fa-sort-down text-gray-400"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Ações em lote (inicialmente oculto) -->
        <div id="bulkActions" class="hidden mb-4 p-4 bg-blue-50 rounded-lg flex items-center justify-between">
            <span class="selected-count text-blue-700 font-medium">0 selecionado(s)</span>
            <div class="flex gap-2">
                <button class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm">
                    <i class="fas fa-trash mr-1"></i>Excluir Selecionados
                </button>
                <button class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm">
                    <i class="fas fa-times mr-1"></i>Cancelar
                </button>
            </div>
        </div>
        
        <!-- Formulário para adicionar usuário -->
        <form id="formNovoUsuario" class="mb-8 p-6 border rounded-xl bg-primary-50 shadow-sm">
            <h3 class="text-lg font-semibold text-primary-700 mb-4 flex items-center">
                <i class="fas fa-user-plus mr-2"></i>Adicionar Novo Usuário
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Nome Completo -->
                <div>
                    <label for="novoUsuarioNome" class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-user mr-1"></i>Nome Completo
                    </label>
                    <input type="text" id="novoUsuarioNome" required 
                           class="w-full p-3 border border-gray-300 rounded-lg shadow-inner focus:ring-primary-500 focus:border-primary-500" 
                           placeholder="Nome do Funcionário">
                </div>
                
                <!-- Email -->
                <div>
                    <label for="novoUsuarioEmail" class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-envelope mr-1"></i>Email
                    </label>
                    <input type="email" id="novoUsuarioEmail" required 
                           class="w-full p-3 border border-gray-300 rounded-lg shadow-inner focus:ring-primary-500 focus:border-primary-500" 
                           placeholder="email@exemplo.com">
                </div>
                
                <!-- Senha -->
                <div>
                    <label for="novoUsuarioSenha" class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-lock mr-1"></i>Senha
                    </label>
                    <div class="relative">
                        <input type="password" id="novoUsuarioSenha" required minlength="6"
                               class="w-full p-3 pr-24 border border-gray-300 rounded-lg shadow-inner focus:ring-primary-500 focus:border-primary-500" 
                               placeholder="Mínimo 6 caracteres">
                        <button type="button" id="btnGerarSenha" 
                                class="absolute right-1 top-1/2 -translate-y-1/2 px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded text-sm transition-all"
                                title="Gerar senha aleatória">
                            <i class="fas fa-sync-alt mr-1"></i>Gerar
                        </button>
                    </div>
                </div>
                
                <!-- Confirmar Senha -->
                <div>
                    <label for="novoUsuarioConfirmarSenha" class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-lock mr-1"></i>Confirmar Senha
                    </label>
                    <input type="password" id="novoUsuarioConfirmarSenha" required minlength="6"
                           class="w-full p-3 border border-gray-300 rounded-lg shadow-inner focus:ring-primary-500 focus:border-primary-500" 
                           placeholder="Digite a senha novamente">
                </div>
                
                <!-- Função -->
                <div>
                    <label for="novoUsuarioRole" class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-user-tag mr-1"></i>Função
                    </label>
                    <select id="novoUsuarioRole" class="w-full p-3 border border-gray-300 rounded-lg shadow-inner focus:ring-primary-500 focus:border-primary-500">
                        <option value="funcionario">Funcionário</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>
                
                <!-- Botão de Adicionar -->
                <div class="md:col-span-2">
                    <button type="submit" id="btnAdicionarUsuario" class="w-full md:w-auto flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300">
                        <i class="fas fa-user-plus mr-2"></i>
                        <span class="button-text">Adicionar Usuário</span>
                        <i class="fas fa-spinner fa-spin hidden" id="addUserSpinner"></i>
                    </button>
                </div>
            </div>
        </form>
        
        <!-- Lista de usuários -->
        <div>
            <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center justify-between">
                <span>
                    <i class="fas fa-users mr-2"></i>Usuários Existentes
                </span>
                <span class="text-sm font-normal text-gray-500">
                    Total: <span id="totalUsersCount">0</span> usuários
                </span>
            </h3>
            
            <div id="listaUsuariosContainer" class="space-y-4">
                <!-- Usuários serão listados aqui pelo JavaScript -->
                <div class="flex items-center justify-center p-10">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin text-3xl text-gray-400 mb-4"></i>
                        <p class="text-gray-500">Carregando usuários...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    </main>

    <!-- Modais -->
    <div id="kpiModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 modal-backdrop">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-96 overflow-y-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 id="modalTitle" class="text-xl font-semibold text-gray-800"></h3>
                        <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="modalContent" class="space-y-4">
                        <!-- Conteúdo do modal será inserido aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="alertModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 modal-backdrop">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Detalhes do Alerta</h3>
                        <button id="closeAlertModal" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="alertModalContent" class="space-y-4">
                        <!-- Conteúdo do modal de alerta será inserido aqui -->
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button id="dismissAlert" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg transition-all">
                            Dispensar
                        </button>
                        <button id="resolveAlert" class="px-4 py-2 bg-success-500 hover:bg-success-600 text-white rounded-lg transition-all">
                            Resolver
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="src/js/firebase-config.js"></script>
    <script src="src/js/shared.js"></script>
    <script src="src/js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            protectRoute(['admin']);
                // Importar classe UserManager se disponível
                if (window.UserManager && !window.userManager) {
                    window.userManager = new window.UserManager();
                }
            const formatCurrency = (value) => {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value || 0);
            };

            const formatPercent = (value) => {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'percent',
                    minimumFractionDigits: 1
                }).format((value || 0) / 100);
            };

            let currentData = {
                vendas: 0,
                ticket: 0,
                pedidos: 0,
                divergencias: 0,
                caixa: 0,
                lucro: 0,
                turnos: [],
                alertas: [],
                timeline: []
            };

            let charts = {
                payment: null,
                products: null,
                salesHours: null
            };

            function showToast(message, type = 'info', duration = 5000) {
                const toast = document.createElement('div');
                toast.className = `toast show bg-white border-l-4 rounded-lg shadow-lg p-4 mb-2 transform transition-all duration-300`;
                
                const colors = {
                    success: 'border-success-500 text-success-800',
                    error: 'border-danger-500 text-danger-800',
                    warning: 'border-warning-500 text-warning-800',
                    info: 'border-blue-500 text-blue-800'
                };
                
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };
                
                toast.classList.add(...colors[type].split(' '));
                
                toast.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas ${icons[type]} mr-3"></i>
                        <span class="flex-1">${message}</span>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                document.getElementById('toast-container').appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }

            function setupTabs() {
                const tabButtons = document.querySelectorAll('.tab-button');
                const tabContents = document.querySelectorAll('.tab-content');
                
                function switchTab(activeButton, activeContent) {
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active', 'bg-primary-500', 'text-white', 'font-semibold');
                        btn.classList.add('bg-gray-200', 'text-gray-700', 'font-medium');
                    });
                    
                    tabContents.forEach(content => content.classList.add('hidden'));
                    
                    activeButton.classList.remove('bg-gray-200', 'text-gray-700', 'font-medium');
                    activeButton.classList.add('active', 'bg-primary-500', 'text-white', 'font-semibold');
                    activeContent.classList.remove('hidden');
                }
                
                document.getElementById('btnTabDashboard').addEventListener('click', () => {
                    switchTab(document.getElementById('btnTabDashboard'), document.getElementById('tabContentDashboard'));
                    loadDashboardData();
                });
                
                document.getElementById('btnTabPrecos').addEventListener('click', () => {
                    switchTab(document.getElementById('btnTabPrecos'), document.getElementById('tabContentPrecos'));
                    loadPricesData();
                });
                
                document.getElementById('btnTabUsuarios').addEventListener('click', () => {
                    switchTab(document.getElementById('btnTabUsuarios'), document.getElementById('tabContentUsuarios'));
                    loadUsersData();
                });
            }

            function setupPeriodFilters() {
                const filterChips = document.querySelectorAll('.filter-chip');
                const customDateRange = document.getElementById('customDateRange');
                
                filterChips.forEach(chip => {
                    chip.addEventListener('click', () => {
                        filterChips.forEach(c => c.classList.remove('active'));
                        chip.classList.add('active');
                        
                        if (chip.dataset.period === 'custom') {
                            customDateRange.classList.remove('hidden');
                        } else {
                            customDateRange.classList.add('hidden');
                            applyPeriodFilter(chip.dataset.period);
                        }
                    });
                });
                
                document.getElementById('applyCustomRange').addEventListener('click', () => {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    
                    if (startDate && endDate) {
                        applyCustomRangeFilter(startDate, endDate);
                        showToast('Período personalizado aplicado', 'success');
                    } else {
                        showToast('Selecione as datas de início e fim', 'warning');
                    }
                });
            }

            function applyPeriodFilter(period) {
                const now = new Date();
                let startDate, endDate;
                
                switch (period) {
                    case 'today':
                        startDate = new Date(now);
                        endDate = new Date(now);
                        break;
                    case 'yesterday':
                        startDate = new Date(now);
                        startDate.setDate(now.getDate() - 1);
                        endDate = new Date(startDate);
                        break;
                    case 'week':
                        startDate = new Date(now);
                        startDate.setDate(now.getDate() - now.getDay());
                        endDate = new Date(now);
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now);
                        break;
                }
                
                loadDashboardData(startDate, endDate);
            }

            function applyCustomRangeFilter(start, end) {
                const startDate = new Date(start);
                const endDate = new Date(end);
                loadDashboardData(startDate, endDate);
            }

            async function loadDashboardData(startDate = null, endDate = null) {
    try {
        document.getElementById('refreshIcon').classList.add('animate-spin');
        
        // Obter valores dos filtros
        const filterTurno = document.getElementById('filterTurno').value;
        const filterPagamento = document.getElementById('filterPagamento').value;
        
        // Se não houver datas, usar últimos 30 dias
        if (!startDate || !endDate) {
            endDate = new Date();
            startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
        }
        
        // Normalizar datas para início e fim do dia
        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(23, 59, 59, 999);
        
        console.log('Carregando dados:', {
            startDate: startDate.toISOString(),
            endDate: endDate.toISOString(),
            turno: filterTurno,
            pagamento: filterPagamento
        });
        
        // Buscar todos os turnos no período
        const turnosSnapshot = await db.collection('turnos')
            .where('status', '==', 'fechado')
            .get();
        
        // Filtrar manualmente por data e outros critérios
        const turnos = [];
        turnosSnapshot.forEach(doc => {
            const data = doc.data();
            const turnoId = doc.id;
            
            // Extrair data do ID do turno (formato: YYYY-MM-DD_Periodo)
            const [dataPart, periodoPart] = turnoId.split('_');
            const turnoDate = new Date(dataPart + 'T12:00:00');
            
            // Verificar se está no período
            if (turnoDate >= startDate && turnoDate <= endDate) {
                // Aplicar filtro de turno se selecionado
                if (!filterTurno || periodoPart === filterTurno) {
                    turnos.push({ 
                        id: turnoId, 
                        ...data,
                        dataObj: turnoDate,
                        periodo: periodoPart
                    });
                }
            }
        });
        
        // Ordenar por data
        turnos.sort((a, b) => a.dataObj - b.dataObj);
        
        console.log(`Encontrados ${turnos.length} turnos após filtros`);
        
        // Se houver filtro de pagamento, filtrar turnos
        let turnosFiltrados = turnos;
        if (filterPagamento) {
            turnosFiltrados = turnos.filter(turno => {
                if (!turno.formasPagamento) return false;
                
                const pagamentoMap = {
                    'dinheiro': turno.formasPagamento.dinheiro,
                    'pixManual': turno.formasPagamento.pixManual,
                    'stoneDCV': turno.formasPagamento.stoneDCV,
                    'stoneVoucher': turno.formasPagamento.stoneVoucher,
                    'pagbankDCV': turno.formasPagamento.pagbankDCV
                };
                
                return pagamentoMap[filterPagamento] && pagamentoMap[filterPagamento] > 0;
            });
        }
        
        // Calcular período anterior para comparação
        const diasPeriodo = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
        const startDateAnterior = new Date(startDate);
        startDateAnterior.setDate(startDateAnterior.getDate() - diasPeriodo);
        const endDateAnterior = new Date(startDate);
        endDateAnterior.setDate(endDateAnterior.getDate() - 1);
        
        // Buscar turnos do período anterior
        const turnosAnterioresSnapshot = await db.collection('turnos')
            .where('status', '==', 'fechado')
            .get();
            
        const turnosAnteriores = [];
        turnosAnterioresSnapshot.forEach(doc => {
            const data = doc.data();
            const turnoId = doc.id;
            const [dataPart, periodoPart] = turnoId.split('_');
            const turnoDate = new Date(dataPart + 'T12:00:00');
            
            if (turnoDate >= startDateAnterior && turnoDate <= endDateAnterior) {
                if (!filterTurno || periodoPart === filterTurno) {
                    turnosAnteriores.push({ id: turnoId, ...data });
                }
            }
        });
        
        await updateKPIs(turnosFiltrados, turnosAnteriores);
        await updateCharts(turnosFiltrados);
        await updateAlertsAndTurnos();
        await updateTimeline(startDate, endDate);
        
        showToast('Dashboard atualizado com sucesso', 'success');
        
    } catch (error) {
        console.error('Erro ao carregar dados do dashboard:', error);
        showToast('Erro ao carregar dados do dashboard', 'error');
    } finally {
        document.getElementById('refreshIcon').classList.remove('animate-spin');
    }
}

// SUBSTITUIR A FUNÇÃO updateKPIs PARA INCLUIR CÁLCULO DE TENDÊNCIAS
async function updateKPIs(turnos, turnosAnteriores = []) {
    // Cálculos do período atual
    let totalVendas = 0;
    let totalPedidos = turnos.length;
    let totalDivergencias = 0;
    let totalCaixa = 0;
    
    turnos.forEach(turno => {
        totalVendas += turno.totalVendidoCalculadoFinal || 0;
        totalCaixa += turno.caixaFinalContado || 0;
        
        const vendidoCalc = turno.totalVendidoCalculadoFinal || 0;
        const pagamentosReg = turno.totalRegistradoPagamentosFinal || 0;
        const diffCaixa = turno.diferencaCaixaFinal || 0;
        
        if (Math.abs(vendidoCalc - pagamentosReg) > 0.01 || Math.abs(diffCaixa) > 0.01) {
            totalDivergencias++;
        }
    });
    
    // Cálculos do período anterior
    let totalVendasAnterior = 0;
    let totalPedidosAnterior = turnosAnteriores.length;
    let totalDivergenciasAnterior = 0;
    let totalCaixaAnterior = 0;
    
    turnosAnteriores.forEach(turno => {
        totalVendasAnterior += turno.totalVendidoCalculadoFinal || 0;
        totalCaixaAnterior += turno.caixaFinalContado || 0;
        
        const vendidoCalc = turno.totalVendidoCalculadoFinal || 0;
        const pagamentosReg = turno.totalRegistradoPagamentosFinal || 0;
        const diffCaixa = turno.diferencaCaixaFinal || 0;
        
        if (Math.abs(vendidoCalc - pagamentosReg) > 0.01 || Math.abs(diffCaixa) > 0.01) {
            totalDivergenciasAnterior++;
        }
    });
    
    const ticketMedio = totalPedidos > 0 ? totalVendas / totalPedidos : 0;
    const ticketMedioAnterior = totalPedidosAnterior > 0 ? totalVendasAnterior / totalPedidosAnterior : 0;
    const percentualDivergencias = totalPedidos > 0 ? (totalDivergencias / totalPedidos) * 100 : 0;
    const percentualDivergenciasAnterior = totalPedidosAnterior > 0 ? (totalDivergenciasAnterior / totalPedidosAnterior) * 100 : 0;
    const lucroEstimado = totalVendas * 0.35;
    const lucroEstimadoAnterior = totalVendasAnterior * 0.35;
    
    // Calcular tendências
    const calcularTendencia = (atual, anterior) => {
        if (anterior === 0) return atual > 0 ? 100 : 0;
        return ((atual - anterior) / anterior) * 100;
    };
    
    const tendenciaVendas = calcularTendencia(totalVendas, totalVendasAnterior);
    const tendenciaTicket = calcularTendencia(ticketMedio, ticketMedioAnterior);
    const tendenciaPedidos = calcularTendencia(totalPedidos, totalPedidosAnterior);
    const tendenciaDivergencias = calcularTendencia(percentualDivergencias, percentualDivergenciasAnterior);
    const tendenciaCaixa = calcularTendencia(totalCaixa, totalCaixaAnterior);
    const tendenciaLucro = calcularTendencia(lucroEstimado, lucroEstimadoAnterior);
    
    // Atualizar valores
    document.getElementById('kpiVendas').textContent = formatCurrency(totalVendas);
    document.getElementById('kpiTicket').textContent = formatCurrency(ticketMedio);
    document.getElementById('kpiPedidos').textContent = totalPedidos;
    document.getElementById('kpiDivergencias').textContent = formatPercent(percentualDivergencias);
    document.getElementById('kpiCaixa').textContent = formatCurrency(totalCaixa);
    document.getElementById('kpiLucro').textContent = formatCurrency(lucroEstimado);
    
    // Atualizar tendências
    updateTrendIndicator('kpiVendasTrend', tendenciaVendas);
    updateTrendIndicator('kpiTicketTrend', tendenciaTicket);
    updateTrendIndicator('kpiPedidosTrend', tendenciaPedidos);
    updateTrendIndicator('kpiDivergenciasTrend', -tendenciaDivergencias); // Negativo porque menos divergências é melhor
    updateTrendIndicator('kpiCaixaTrend', tendenciaCaixa, true); // true = mostrar como status
    updateTrendIndicator('kpiLucroTrend', tendenciaLucro);
    
    currentData = {
        vendas: totalVendas,
        ticket: ticketMedio,
        pedidos: totalPedidos,
        divergencias: percentualDivergencias,
        caixa: totalCaixa,
        lucro: lucroEstimado,
        turnos: turnos
    };
}

// NOVA FUNÇÃO PARA ATUALIZAR INDICADORES DE TENDÊNCIA
function updateTrendIndicator(elementId, percentChange, isStatus = false) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    if (isStatus) {
        // Para status (como caixa atual)
        element.innerHTML = `
            <i class="fas fa-circle text-success-500 mr-1"></i>
            <span>Atualizado</span>
        `;
    } else {
        // Para tendências
        const isPositive = percentChange >= 0;
        const icon = isPositive ? 'fa-arrow-up' : 'fa-arrow-down';
        const colorClass = isPositive ? 'text-success-500' : 'text-danger-500';
        
        element.innerHTML = `
            <i class="fas ${icon} ${colorClass} mr-1"></i>
            <span>${Math.abs(percentChange).toFixed(1)}%</span>
        `;
    }
}

            async function updateKPIs(turnos) {
                let totalVendas = 0;
                let totalPedidos = turnos.length;
                let totalDivergencias = 0;
                let totalCaixa = 0;
                
                turnos.forEach(turno => {
                    totalVendas += turno.totalVendidoCalculadoFinal || 0;
                    totalCaixa += turno.caixaFinalContado || 0;
                    
                    const vendidoCalc = turno.totalVendidoCalculadoFinal || 0;
                    const pagamentosReg = turno.totalRegistradoPagamentosFinal || 0;
                    const diffCaixa = turno.diferencaCaixaFinal || 0;
                    
                    if (Math.abs(vendidoCalc - pagamentosReg) > 0.01 || Math.abs(diffCaixa) > 0.01) {
                        totalDivergencias++;
                    }
                });
                
                const ticketMedio = totalPedidos > 0 ? totalVendas / totalPedidos : 0;
                const percentualDivergencias = totalPedidos > 0 ? (totalDivergencias / totalPedidos) * 100 : 0;
                const lucroEstimado = totalVendas * 0.35; // Estimativa de 35% de margem
                
                document.getElementById('kpiVendas').textContent = formatCurrency(totalVendas);
                document.getElementById('kpiTicket').textContent = formatCurrency(ticketMedio);
                document.getElementById('kpiPedidos').textContent = totalPedidos;
                document.getElementById('kpiDivergencias').textContent = formatPercent(percentualDivergencias);
                document.getElementById('kpiCaixa').textContent = formatCurrency(totalCaixa);
                document.getElementById('kpiLucro').textContent = formatCurrency(lucroEstimado);
                
                currentData = {
                    vendas: totalVendas,
                    ticket: ticketMedio,
                    pedidos: totalPedidos,
                    divergencias: percentualDivergencias,
                    caixa: totalCaixa,
                    lucro: lucroEstimado
                };
            }

            async function updateCharts(turnos) {
                updatePaymentChart(turnos);
                updateProductsChart(turnos);
                updateSalesHoursChart(turnos);
            }

            function updatePaymentChart(turnos) {
                const pagamentos = {
                    'Dinheiro': 0,
                    'PIX Manual': 0,
                    'Stone D/C/V': 0,
                    'Stone Voucher': 0,
                    'PagBank D/C/V': 0
                };
                
                turnos.forEach(turno => {
                    if (turno.formasPagamento) {
                        pagamentos['Dinheiro'] += turno.formasPagamento.dinheiro || 0;
                        pagamentos['PIX Manual'] += turno.formasPagamento.pixManual || 0;
                        pagamentos['Stone D/C/V'] += turno.formasPagamento.stoneDCV || 0;
                        pagamentos['Stone Voucher'] += turno.formasPagamento.stoneVoucher || 0;
                        pagamentos['PagBank D/C/V'] += turno.formasPagamento.pagbankDCV || 0;
                    }
                });
                
                const ctx = document.getElementById('paymentChart').getContext('2d');
                
                if (charts.payment) {
                    charts.payment.destroy();
                }
                
                charts.payment = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(pagamentos),
                        datasets: [{
                            data: Object.values(pagamentos),
                            backgroundColor: [
                                '#F97316',
                                '#22C55E',
                                '#3B82F6',
                                '#8B5CF6',
                                '#EF4444'
                            ],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            function updateProductsChart(turnos) {
                const produtos = {};
                
                turnos.forEach(turno => {
                    if (turno.itens) {
                        Object.values(turno.itens).forEach(categoria => {
                            Object.entries(categoria).forEach(([itemKey, itemData]) => {
                                if (itemData && typeof itemData.vendido === 'number' && itemData.vendido > 0) {
                                    const nomeAmigavel = itemKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                    if (!produtos[nomeAmigavel]) produtos[nomeAmigavel] = 0;
                                    produtos[nomeAmigavel] += itemData.vendido;
                                }
                            });
                        });
                    }
                    
                    if (turno.gelo && turno.gelo.gelo_pacote && turno.gelo.gelo_pacote.vendas > 0) {
                        if (!produtos['Gelo']) produtos['Gelo'] = 0;
                        produtos['Gelo'] += turno.gelo.gelo_pacote.vendas;
                    }
                });
                
                const sortedProducts = Object.entries(produtos)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 10);
                
                const ctx = document.getElementById('productsChart').getContext('2d');
                
                if (charts.products) {
                    charts.products.destroy();
                }
                
                charts.products = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedProducts.map(([nome]) => nome),
                        datasets: [{
                            label: 'Vendidos',
                            data: sortedProducts.map(([, qtd]) => qtd),
                            backgroundColor: '#F97316',
                            borderColor: '#EA580C',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            function updateSalesHoursChart(turnos) {
                const hoursData = {};
                
                for (let i = 0; i < 24; i++) {
                    hoursData[i] = 0;
                }
                
                turnos.forEach(turno => {
                    if (turno.abertura && turno.abertura.hora) {
                        const hora = parseInt(turno.abertura.hora.split(':')[0]);
                        hoursData[hora] += turno.totalVendidoCalculadoFinal || 0;
                    }
                });
                
                const ctx = document.getElementById('salesHoursChart').getContext('2d');
                
                if (charts.salesHours) {
                    charts.salesHours.destroy();
                }
                
                charts.salesHours = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Object.keys(hoursData).map(h => `${h}:00`),
                        datasets: [{
                            label: 'Vendas por Hora',
                            data: Object.values(hoursData),
                            borderColor: '#F97316',
                            backgroundColor: 'rgba(249, 115, 22, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }

            async function updateAlertsAndTurnos() {
                await updateAlerts();
                await updateTurnos();
            }

            async function updateAlerts() {
                try {
                    const turnosQuery = await db.collection('turnos')
                        .where('status', '==', 'fechado')
                        .orderBy('closedAt', 'desc')
                        .limit(50)
                        .get();
                    
                    const alertas = [];
                    
                    turnosQuery.forEach(doc => {
                        const turno = doc.data();
                        const vendidoCalc = turno.totalVendidoCalculadoFinal || 0;
                        const pagamentosReg = turno.totalRegistradoPagamentosFinal || 0;
                        const diffVendasPagamentos = vendidoCalc - pagamentosReg;
                        const diffCaixa = turno.diferencaCaixaFinal || 0;
                        
                        if (Math.abs(diffVendasPagamentos) > 0.01 || Math.abs(diffCaixa) > 0.01) {
                            const severity = Math.abs(diffVendasPagamentos) > 50 || Math.abs(diffCaixa) > 50 ? 'critical' : 'warning';
                            
                            alertas.push({
                                id: doc.id,
                                turnoId: doc.id,
                                severity: severity,
                                title: 'Divergência Detectada',
                                message: `Turno ${doc.id.split('_')[1]} - ${doc.id.split('_')[0]}`,
                                details: {
                                    vendidoCalc,
                                    pagamentosReg,
                                    diffVendasPagamentos,
                                    diffCaixa,
                                    responsavel: turno.fechamento?.responsavelNome || 'N/A'
                                },
                                timestamp: turno.closedAt?.toDate() || new Date()
                            });
                        }
                    });
                    
                    renderAlerts(alertas);
                    document.getElementById('alertsCount').textContent = alertas.length;
                    
                } catch (error) {
                    console.error('Erro ao carregar alertas:', error);
                }
            }

            function renderAlerts(alertas) {
                const container = document.getElementById('alertsContainer');
                
                if (alertas.length === 0) {
                    container.innerHTML = `
                        <div class="flex items-center justify-center py-8 text-gray-500">
                            <div class="text-center">
                                <i class="fas fa-check-circle text-3xl mb-2 text-success-500"></i>
                                <p>Nenhum alerta no momento</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = alertas.map(alerta => `
                    <div class="severity-${alerta.severity} p-4 rounded-lg table-row-hover cursor-pointer" data-alert-id="${alerta.id}">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center mb-1">
                                    <i class="fas fa-exclamation-triangle text-${alerta.severity === 'critical' ? 'danger' : 'warning'}-500 mr-2"></i>
                                    <h4 class="font-semibold text-gray-800">${alerta.title}</h4>
                                    <span class="ml-2 px-2 py-1 text-xs font-medium rounded-full ${alerta.severity === 'critical' ? 'bg-danger-100 text-danger-800' : 'bg-warning-100 text-warning-800'}">
                                        ${alerta.severity === 'critical' ? 'Crítico' : 'Atenção'}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-600">${alerta.message}</p>
                                <p class="text-xs text-gray-500 mt-1">${new Date(alerta.timestamp).toLocaleString('pt-BR')}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="resolve-alert-btn bg-success-500 hover:bg-success-600 text-white px-3 py-1 rounded text-sm transition-all" data-alert-id="${alerta.id}">
                                    Resolver
                                </button>
                                <i class="fas fa-chevron-right text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                container.querySelectorAll('[data-alert-id]').forEach(element => {
                    element.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('resolve-alert-btn')) {
                            const alertId = element.dataset.alertId;
                            const alerta = alertas.find(a => a.id === alertId);
                            showAlertModal(alerta);
                        }
                    });
                });
                
                container.querySelectorAll('.resolve-alert-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const alertId = btn.dataset.alertId;
                        resolveAlert(alertId);
                    });
                });
            }

            async function updateTurnos() {
                try {
                    const turnosQuery = await db.collection('turnos')
                        .where('status', '==', 'aberto')
                        .get();
                    
                    const turnos = [];
                    turnosQuery.forEach(doc => {
                        turnos.push({ id: doc.id, ...doc.data() });
                    });
                    
                    renderTurnos(turnos);
                    
                } catch (error) {
                    console.error('Erro ao carregar turnos:', error);
                }
            }

            function renderTurnos(turnos) {
                const container = document.getElementById('turnosContainer');
                
                if (turnos.length === 0) {
                    container.innerHTML = `
                        <div class="flex items-center justify-center py-8 text-gray-500">
                            <div class="text-center">
                                <i class="fas fa-clock text-3xl mb-2 text-blue-500"></i>
                                <p>Nenhum turno aberto</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = turnos.map(turno => {
                    const dataHora = turno.id.split('_')[0];
                    const periodo = turno.id.split('_')[1];
                    const responsavel = turno.abertura?.responsavelNome || 'N/A';
                    const horaAbertura = turno.abertura?.hora || 'N/A';
                    
                    return `
                        <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center mb-1">
                                        <i class="fas fa-clock text-blue-500 mr-2"></i>
                                        <h4 class="font-semibold text-gray-800">Turno ${periodo}</h4>
                                        <span class="ml-2 px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">
                                            Aberto
                                        </span>
                                    </div>
                                    <p class="text-sm text-gray-600">${dataHora} - ${horaAbertura}</p>
                                    <p class="text-xs text-gray-500">Responsável: ${responsavel}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-all">
                                        Detalhar
                                    </button>
                                    <button class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded text-sm transition-all">
                                        Transferir
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // SUBSTITUIR A FUNÇÃO updateTimeline COMPLETA
async function updateTimeline(startDate = null, endDate = null) {
    try {
        const events = [];
        
        // Se não houver datas, usar últimas 24 horas
        if (!startDate || !endDate) {
            endDate = new Date();
            startDate = new Date();
            startDate.setHours(startDate.getHours() - 24);
        }
        
        // Buscar abertura e fechamento de turnos
        const turnosQuery = await db.collection('turnos')
            .orderBy('createdAt', 'desc')
            .limit(20)
            .get();
            
        turnosQuery.forEach(doc => {
            const turno = doc.data();
            const turnoId = doc.id;
            
            // Evento de abertura
            if (turno.abertura && turno.createdAt) {
                events.push({
                    id: `${turnoId}_abertura`,
                    type: 'abertura',
                    title: `Turno ${turnoId.split('_')[1]} Aberto`,
                    description: `Aberto por ${turno.abertura.responsavelNome || 'Desconhecido'}`,
                    timestamp: turno.createdAt.toDate ? turno.createdAt.toDate() : new Date(turno.createdAt),
                    icon: 'fa-play-circle',
                    color: 'success',
                    turnoId: turnoId,
                    responsavel: turno.abertura.responsavelNome
                });
            }
            
            // Evento de fechamento
            if (turno.status === 'fechado' && turno.closedAt) {
                const totalVendido = turno.totalVendidoCalculadoFinal || 0;
                events.push({
                    id: `${turnoId}_fechamento`,
                    type: 'fechamento',
                    title: `Turno ${turnoId.split('_')[1]} Fechado`,
                    description: `Fechado por ${turno.fechamento?.responsavelNome || 'Desconhecido'} - ${formatCurrency(totalVendido)}`,
                    timestamp: turno.closedAt.toDate ? turno.closedAt.toDate() : new Date(turno.closedAt),
                    icon: 'fa-stop-circle',
                    color: 'danger',
                    turnoId: turnoId,
                    responsavel: turno.fechamento?.responsavelNome,
                    valor: totalVendido
                });
            }
            
            // Evento de divergência
            if (turno.diferencaCaixaFinal && Math.abs(turno.diferencaCaixaFinal) > 0.01) {
                events.push({
                    id: `${turnoId}_divergencia`,
                    type: 'divergencia',
                    title: 'Divergência Registrada',
                    description: `Diferença de ${formatCurrency(Math.abs(turno.diferencaCaixaFinal))} no turno ${turnoId.split('_')[1]}`,
                    timestamp: turno.closedAt?.toDate ? turno.closedAt.toDate() : new Date(),
                    icon: 'fa-exclamation-triangle',
                    color: 'warning',
                    turnoId: turnoId,
                    valor: turno.diferencaCaixaFinal
                });
            }
        });
        
        // Buscar logs de auditoria se existirem
        try {
            const auditQuery = await db.collection('audit_logs')
                .orderBy('timestamp', 'desc')
                .limit(10)
                .get();
                
            auditQuery.forEach(doc => {
                const log = doc.data();
                
                if (log.action === 'user_created') {
                    events.push({
                        id: doc.id,
                        type: 'usuario',
                        title: 'Novo Usuário Criado',
                        description: `${log.targetUserName || 'Usuário'} adicionado ao sistema`,
                        timestamp: log.timestamp.toDate ? log.timestamp.toDate() : new Date(),
                        icon: 'fa-user-plus',
                        color: 'info'
                    });
                }
                
                if (log.action === 'price_update') {
                    events.push({
                        id: doc.id,
                        type: 'preco',
                        title: 'Preços Atualizados',
                        description: `${log.changedCount || 0} preços alterados`,
                        timestamp: log.timestamp.toDate ? log.timestamp.toDate() : new Date(),
                        icon: 'fa-tags',
                        color: 'purple'
                    });
                }
            });
        } catch (error) {
            console.log('Coleção audit_logs não encontrada ou vazia');
        }
        
        // Ordenar eventos por timestamp (mais recentes primeiro)
        events.sort((a, b) => b.timestamp - a.timestamp);
        
        // Filtrar por período se especificado
        const eventsFiltrados = events.filter(event => {
            return event.timestamp >= startDate && event.timestamp <= endDate;
        });
        
        renderTimeline(eventsFiltrados.slice(0, 50)); // Limitar a 50 eventos
        
    } catch (error) {
        console.error('Erro ao carregar timeline:', error);
        renderTimeline([]); // Renderizar vazio em caso de erro
    }
}

// IMPLEMENTAR FUNÇÃO DE EXPORTAR TIMELINE
async function exportTimeline() {
    try {
        showToast('Preparando exportação...', 'info');
        
        // Buscar todos os eventos da timeline
        const events = [];
        
        // Buscar turnos dos últimos 30 dias
        const dataLimite = new Date();
        dataLimite.setDate(dataLimite.getDate() - 30);
        
        const turnosQuery = await db.collection('turnos')
            .where('status', '==', 'fechado')
            .orderBy('closedAt', 'desc')
            .get();
            
        turnosQuery.forEach(doc => {
            const turno = doc.data();
            const turnoId = doc.id;
            
            if (turno.closedAt) {
                const data = turno.closedAt.toDate ? turno.closedAt.toDate() : new Date(turno.closedAt);
                
                events.push({
                    data: data.toLocaleString('pt-BR'),
                    tipo: 'Fechamento',
                    turno: turnoId,
                    responsavel: turno.fechamento?.responsavelNome || 'N/A',
                    totalVendido: turno.totalVendidoCalculadoFinal || 0,
                    diferenca: turno.diferencaCaixaFinal || 0,
                    observacoes: turno.fechamento?.observacoes || ''
                });
            }
        });
        
        if (events.length === 0) {
            showToast('Nenhum evento encontrado para exportar', 'warning');
            return;
        }
        
        // Converter para CSV
        const headers = ['Data/Hora', 'Tipo', 'Turno', 'Responsável', 'Total Vendido', 'Diferença', 'Observações'];
        const csvContent = [
            headers.join(','),
            ...events.map(event => [
                `"${event.data}"`,
                event.tipo,
                event.turno,
                `"${event.responsavel}"`,
                event.totalVendido.toFixed(2).replace('.', ','),
                event.diferenca.toFixed(2).replace('.', ','),
                `"${event.observacoes}"`
            ].join(','))
        ].join('\n');
        
        // Criar blob e download
        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `timeline_${getFormattedDate()}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast(`Timeline exportada com sucesso (${events.length} eventos)`, 'success');
        
    } catch (error) {
        console.error('Erro ao exportar timeline:', error);
        showToast('Erro ao exportar timeline', 'error');
    }
}

// IMPLEMENTAR BUSCA NA TIMELINE
function setupTimelineSearch() {
    const searchInput = document.getElementById('timelineSearch');
    if (!searchInput) return;
    
    let searchTimeout;
    
    searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const searchTerm = e.target.value.toLowerCase();
        
        searchTimeout = setTimeout(() => {
            const timelineItems = document.querySelectorAll('.timeline-item');
            
            timelineItems.forEach(item => {
                const title = item.querySelector('h4')?.textContent.toLowerCase() || '';
                const description = item.querySelector('p')?.textContent.toLowerCase() || '';
                
                if (!searchTerm || title.includes(searchTerm) || description.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Mostrar mensagem se nenhum resultado
            const visibleItems = document.querySelectorAll('.timeline-item:not([style*="display: none"])');
            const container = document.getElementById('timelineContainer');
            
            const noResultsMsg = container.querySelector('.no-results-message');
            if (visibleItems.length === 0 && searchTerm) {
                if (!noResultsMsg) {
                    const msg = document.createElement('div');
                    msg.className = 'no-results-message text-center py-8 text-gray-500';
                    msg.innerHTML = `
                        <i class="fas fa-search text-3xl mb-2"></i>
                        <p>Nenhum evento encontrado para "${searchTerm}"</p>
                    `;
                    container.appendChild(msg);
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }, 300);
    });
}

// IMPLEMENTAR FILTRO DO GRÁFICO DE VENDAS POR HORA
function setupSalesHoursFilter() {
    const select = document.getElementById('salesHoursPeriod');
    if (!select) return;
    
    select.addEventListener('change', async (e) => {
        const period = e.target.value;
        let startDate, endDate;
        
        const now = new Date();
        endDate = new Date(now);
        
        switch(period) {
            case 'today':
                startDate = new Date(now);
                startDate.setHours(0, 0, 0, 0);
                break;
            case 'week':
                startDate = new Date(now);
                startDate.setDate(now.getDate() - 7);
                break;
            case 'month':
                startDate = new Date(now);
                startDate.setMonth(now.getMonth() - 1);
                break;
            default:
                startDate = new Date(now);
                startDate.setHours(0, 0, 0, 0);
        }
        
        // Recarregar apenas o gráfico de vendas por hora
        await updateSalesHoursChartWithPeriod(startDate, endDate);
    });
}

// FUNÇÃO PARA ATUALIZAR APENAS O GRÁFICO DE VENDAS POR HORA
async function updateSalesHoursChartWithPeriod(startDate, endDate) {
    try {
        // Buscar turnos no período
        const turnosQuery = await db.collection('turnos')
            .where('status', '==', 'fechado')
            .get();
            
        const turnos = [];
        turnosQuery.forEach(doc => {
            const data = doc.data();
            const turnoId = doc.id;
            const [dataPart] = turnoId.split('_');
            const turnoDate = new Date(dataPart + 'T12:00:00');
            
            if (turnoDate >= startDate && turnoDate <= endDate) {
                turnos.push({ id: turnoId, ...data });
            }
        });
        
        // Atualizar apenas o gráfico
        updateSalesHoursChart(turnos);
        
    } catch (error) {
        console.error('Erro ao atualizar gráfico de vendas por hora:', error);
    }
}

            function renderTimeline(timeline) {
                const container = document.getElementById('timelineContainer');
                
                container.innerHTML = timeline.map((item, index) => `
                    <div class="timeline-item relative flex items-start space-x-4 ${index !== timeline.length - 1 ? 'pb-6' : ''}">
                        <div class="timeline-dot w-8 h-8 bg-${item.color}-100 rounded-full flex items-center justify-center">
                            <i class="fas ${item.icon} text-${item.color}-600 text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between">
                                <h4 class="text-sm font-semibold text-gray-800">${item.title}</h4>
                                <span class="text-xs text-gray-500">${item.timestamp.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">${item.description}</p>
                        </div>
                    </div>
                `).join('');
            }

            function setupKPIModals() {
                const kpiCards = document.querySelectorAll('.kpi-card');
                const modal = document.getElementById('kpiModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');
                const closeModal = document.getElementById('closeModal');
                
                kpiCards.forEach(card => {
                    card.addEventListener('click', () => {
                        const kpiType = card.dataset.kpi;
                        showKPIModal(kpiType);
                    });
                });
                
                closeModal.addEventListener('click', () => {
                    modal.classList.add('hidden');
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            }

            function showKPIModal(kpiType) {
                const modal = document.getElementById('kpiModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');
                
                const titles = {
                    vendas: 'Detalhes das Vendas Brutas',
                    ticket: 'Análise do Ticket Médio',
                    pedidos: 'Resumo dos Pedidos',
                    divergencias: 'Análise de Divergências',
                    caixa: 'Status do Caixa',
                    lucro: 'Projeção de Lucro'
                };
                
                modalTitle.textContent = titles[kpiType] || 'Detalhes';
                
                const content = generateKPIModalContent(kpiType);
                modalContent.innerHTML = content;
                
                modal.classList.remove('hidden');
            }

            function generateKPIModalContent(kpiType) {
                const data = currentData;
                
                switch (kpiType) {
                    case 'vendas':
                        return `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-primary-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-primary-700 mb-2">Total de Vendas</h4>
                                    <p class="text-2xl font-bold text-primary-600">${formatCurrency(data.vendas)}</p>
                                </div>
                                <div class="bg-success-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-success-700 mb-2">Crescimento</h4>
                                    <p class="text-2xl font-bold text-success-600">+12.5%</p>
                                </div>
                            </div>
                            <div class="mt-4">
                                <h4 class="font-semibold mb-2">Vendas por Período</h4>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span>Manhã:</span>
                                        <span class="font-semibold">${formatCurrency(data.vendas * 0.3)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Tarde:</span>
                                        <span class="font-semibold">${formatCurrency(data.vendas * 0.4)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Noite:</span>
                                        <span class="font-semibold">${formatCurrency(data.vendas * 0.3)}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    case 'ticket':
                        return `
                            <div class="text-center mb-4">
                                <p class="text-3xl font-bold text-success-600">${formatCurrency(data.ticket)}</p>
                                <p class="text-gray-600">Ticket médio atual</p>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span>Meta mensal:</span>
                                    <span class="font-semibold">${formatCurrency(25.00)}</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-success-500 h-2 rounded-full" style="width: ${Math.min((data.ticket / 25) * 100, 100)}%"></div>
                                </div>
                                <p class="text-sm text-gray-600">
                                    ${data.ticket >= 25 ? '✅ Meta atingida!' : `Faltam ${formatCurrency(25 - data.ticket)} para atingir a meta`}
                                </p>
                            </div>
                        `;
                    default:
                        return `
                            <div class="text-center py-8">
                                <i class="fas fa-chart-bar text-4xl text-gray-400 mb-4"></i>
                                <p class="text-gray-600">Detalhes em desenvolvimento</p>
                            </div>
                        `;
                }
            }

            function showAlertModal(alerta) {
                const modal = document.getElementById('alertModal');
                const modalContent = document.getElementById('alertModalContent');
                
                modalContent.innerHTML = `
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-${alerta.severity === 'critical' ? 'danger' : 'warning'}-500 text-xl mr-3"></i>
                            <div>
                                <h4 class="font-semibold">${alerta.title}</h4>
                                <p class="text-sm text-gray-600">${alerta.message}</p>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h5 class="font-semibold mb-2">Detalhes da Divergência:</h5>
                            <div class="space-y-1 text-sm">
                                <div class="flex justify-between">
                                    <span>Total Vendido:</span>
                                    <span>${formatCurrency(alerta.details.vendidoCalc)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Total Pagamentos:</span>
                                    <span>${formatCurrency(alerta.details.pagamentosReg)}</span>
                                </div>
                                <div class="flex justify-between font-semibold">
                                    <span>Diferença:</span>
                                    <span class="${alerta.details.diffVendasPagamentos < 0 ? 'text-danger-600' : 'text-warning-600'}">${formatCurrency(alerta.details.diffVendasPagamentos)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Responsável:</span>
                                    <span>${alerta.details.responsavel}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Justificativa (opcional):</label>
                            <textarea id="alertJustification" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="3" placeholder="Descreva a justificativa para esta divergência..."></textarea>
                        </div>
                    </div>
                `;
                
                modal.classList.remove('hidden');
                
                document.getElementById('dismissAlert').onclick = () => {
                    modal.classList.add('hidden');
                };
                
                document.getElementById('resolveAlert').onclick = () => {
                    const justification = document.getElementById('alertJustification').value;
                    resolveAlert(alerta.id, justification);
                    modal.classList.add('hidden');
                };
                
                document.getElementById('closeAlertModal').onclick = () => {
                    modal.classList.add('hidden');
                };
            }

            function resolveAlert(alertId, justification = '') {
                showToast(`Alerta ${alertId} resolvido com sucesso`, 'success');
                updateAlertsAndTurnos();
            }

            // Função aprimorada para carregar preços
            async function loadPricesData() {
                showToast('Carregando dados de preços...', 'info');
                
                // Se existir um gerenciador de preços aprimorado, usá-lo
                if (window.enhancedPriceManager) {
                    try {
                        await window.enhancedPriceManager.load();
                        return true;
                    } catch (error) {
                        console.error("Erro ao carregar preços com o gerenciador aprimorado:", error);
                        showToast("Erro ao carregar preços: " + error.message, "error");
                        return false;
                    }
                } 
                // Se existir o priceManager do admin-controller.js
                else if (window.priceManager) {
                    try {
                        await window.priceManager.load();
                        return true;
                    } catch (error) {
                        console.error("Erro ao carregar preços com o priceManager:", error);
                        showToast("Erro ao carregar preços: " + error.message, "error");
                        return false;
                    }
                }
                // Sem gerenciador disponível, tentar usar o código de correção
                else {
                    console.warn("Nenhum gerenciador de preços encontrado, verificando script de correção...");
                    showToast("Inicializando sistema de preços...", "info");
                    
                    // Esperar 500ms para que o script de correção seja carregado
                    return new Promise(resolve => {
                        setTimeout(async () => {
                            // Verificar novamente se o enhancedPriceManager foi carregado
                            if (window.enhancedPriceManager) {
                                try {
                                    await window.enhancedPriceManager.load();
                                    resolve(true);
                                } catch (error) {
                                    console.error("Erro ao carregar preços com o gerenciador aprimorado:", error);
                                    showToast("Erro ao carregar preços: " + error.message, "error");
                                    resolve(false);
                                }
                            } else {
                                showToast("Sistema de preços não encontrado. Recarregue a página.", "error");
                                resolve(false);
                            }
                        }, 500);
                    });
                }
            }

            async function loadUsersData() {
    showToast('Carregando dados de usuários...', 'info');
    
    // Criar o userManager se não existir
    if (!window.userManager) {
        console.log("Criando nova instância do UserManager...");
        window.userManager = new UserManager();
    }
    
    try {
        await window.userManager.load();
        return true;
    } catch (error) {
        console.error("Erro ao carregar usuários:", error);
        showToast("Erro ao carregar usuários: " + error.message, "error");
        return false;
    }
}

            // ATUALIZAR A FUNÇÃO setupEventListeners
function setupEventListeners() {
    // Botão de refresh principal
    document.getElementById('refreshData').addEventListener('click', () => {
        const activePeriod = document.querySelector('.filter-chip.active');
        if (activePeriod?.dataset.period === 'custom') {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            if (startDate && endDate) {
                applyCustomRangeFilter(startDate, endDate);
            } else {
                loadDashboardData();
            }
        } else {
            loadDashboardData();
        }
    });
    
    // Filtros de turno e pagamento
    document.getElementById('filterTurno').addEventListener('change', () => {
        const activePeriod = document.querySelector('.filter-chip.active');
        if (activePeriod) {
            const period = activePeriod.dataset.period;
            if (period === 'custom') {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                if (startDate && endDate) {
                    applyCustomRangeFilter(startDate, endDate);
                }
            } else {
                applyPeriodFilter(period);
            }
        } else {
            loadDashboardData();
        }
    });
    
    document.getElementById('filterPagamento').addEventListener('change', () => {
        const activePeriod = document.querySelector('.filter-chip.active');
        if (activePeriod) {
            const period = activePeriod.dataset.period;
            if (period === 'custom') {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                if (startDate && endDate) {
                    applyCustomRangeFilter(startDate, endDate);
                }
            } else {
                applyPeriodFilter(period);
            }
        } else {
            loadDashboardData();
        }
    });
    
    // Limpar alertas
    document.getElementById('clearAllAlerts').addEventListener('click', async () => {
        if (confirm('Tem certeza que deseja marcar todos os alertas como resolvidos?')) {
            try {
                // Buscar todos os alertas ativos
                const alertElements = document.querySelectorAll('[data-alert-id]');
                const alertIds = Array.from(alertElements).map(el => el.dataset.alertId);
                
                // Criar batch para atualizar todos
                const batch = db.batch();
                
                for (const alertId of alertIds) {
                    // Criar registro de resolução
                    const resolucaoRef = db.collection('alertas_resolvidos').doc();
                    batch.set(resolucaoRef, {
                        turnoId: alertId,
                        resolvidoPor: auth.currentUser.uid,
                        resolvidoEm: firebase.firestore.FieldValue.serverTimestamp(),
                        tipo: 'limpeza_em_massa'
                    });
                }
                
                await batch.commit();
                
                showToast('Todos os alertas foram marcados como resolvidos', 'success');
                updateAlertsAndTurnos();
                
            } catch (error) {
                console.error('Erro ao limpar alertas:', error);
                showToast('Erro ao limpar alertas', 'error');
            }
        }
    });
    
    // Refresh turnos
    document.getElementById('refreshTurnos').addEventListener('click', () => {
        const icon = document.querySelector('#refreshTurnos i');
        icon.classList.add('animate-spin');
        
        updateTurnos().finally(() => {
            icon.classList.remove('animate-spin');
        });
    });
    
    // Exportar timeline
    document.getElementById('exportTimeline').addEventListener('click', () => {
        exportTimeline();
    });
    
    // Configurar busca na timeline
    setupTimelineSearch();
    
    // Configurar filtro de vendas por hora
    setupSalesHoursFilter();
}

// IMPLEMENTAR FUNÇÃO PARA RESOLVER ALERTAS INDIVIDUALMENTE
async function resolveAlert(alertId, justification = '') {
    try {
        // Criar registro de resolução
        await db.collection('alertas_resolvidos').add({
            turnoId: alertId,
            resolvidoPor: auth.currentUser.uid,
            resolvidoEm: firebase.firestore.FieldValue.serverTimestamp(),
            justificativa: justification,
            tipo: 'resolucao_individual'
        });
        
        showToast(`Alerta ${alertId} resolvido com sucesso`, 'success');
        updateAlertsAndTurnos();
        
    } catch (error) {
        console.error('Erro ao resolver alerta:', error);
        showToast('Erro ao resolver alerta', 'error');
    }
}

// MELHORAR A FUNÇÃO renderAlerts
function renderAlerts(alertas) {
    const container = document.getElementById('alertsContainer');
    
    if (alertas.length === 0) {
        container.innerHTML = `
            <div class="flex items-center justify-center py-8 text-gray-500">
                <div class="text-center">
                    <i class="fas fa-check-circle text-3xl mb-2 text-success-500"></i>
                    <p>Nenhum alerta no momento</p>
                </div>
            </div>
        `;
        return;
    }
    
    // Agrupar alertas por severidade
    const alertasCriticos = alertas.filter(a => a.severity === 'critical');
    const alertasAtencao = alertas.filter(a => a.severity === 'warning');
    
    let html = '';
    
    // Renderizar alertas críticos primeiro
    if (alertasCriticos.length > 0) {
        html += '<div class="mb-4"><h5 class="text-xs font-semibold text-danger-600 mb-2">CRÍTICOS</h5>';
        html += alertasCriticos.map(alerta => renderAlertItem(alerta)).join('');
        html += '</div>';
    }
    
    // Depois alertas de atenção
    if (alertasAtencao.length > 0) {
        html += '<div><h5 class="text-xs font-semibold text-warning-600 mb-2">ATENÇÃO</h5>';
        html += alertasAtencao.map(alerta => renderAlertItem(alerta)).join('');
        html += '</div>';
    }
    
    container.innerHTML = html;
    
    // Re-anexar event listeners
    container.querySelectorAll('[data-alert-id]').forEach(element => {
        element.addEventListener('click', (e) => {
            if (!e.target.classList.contains('resolve-alert-btn')) {
                const alertId = element.dataset.alertId;
                const alerta = alertas.find(a => a.id === alertId);
                showAlertModal(alerta);
            }
        });
    });
    
    container.querySelectorAll('.resolve-alert-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const alertId = btn.dataset.alertId;
            resolveAlert(alertId);
        });
    });
}

// FUNÇÃO AUXILIAR PARA RENDERIZAR UM ITEM DE ALERTA
function renderAlertItem(alerta) {
    const timeDiff = new Date() - alerta.timestamp;
    const minutesAgo = Math.floor(timeDiff / 60000);
    const hoursAgo = Math.floor(minutesAgo / 60);
    
    let timeText = 'agora';
    if (hoursAgo > 0) {
        timeText = `há ${hoursAgo}h`;
    } else if (minutesAgo > 0) {
        timeText = `há ${minutesAgo}min`;
    }
    
    return `
        <div class="severity-${alerta.severity} p-4 rounded-lg table-row-hover cursor-pointer mb-2 transition-all duration-200" data-alert-id="${alerta.id}">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <div class="flex items-center mb-1">
                        <i class="fas fa-exclamation-triangle text-${alerta.severity === 'critical' ? 'danger' : 'warning'}-500 mr-2"></i>
                        <h4 class="font-semibold text-gray-800">${alerta.title}</h4>
                        <span class="ml-2 px-2 py-1 text-xs font-medium rounded-full ${alerta.severity === 'critical' ? 'bg-danger-100 text-danger-800' : 'bg-warning-100 text-warning-800'}">
                            ${alerta.severity === 'critical' ? 'Crítico' : 'Atenção'}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600">${alerta.message}</p>
                    <div class="flex items-center space-x-4 mt-1">
                        <p class="text-xs text-gray-500">${timeText}</p>
                        <p class="text-xs text-gray-500">Diferença: ${formatCurrency(Math.abs(alerta.details.diffVendasPagamentos))}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button class="resolve-alert-btn bg-success-500 hover:bg-success-600 text-white px-3 py-1 rounded text-sm transition-all" data-alert-id="${alerta.id}">
                        <i class="fas fa-check mr-1"></i>Resolver
                    </button>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </div>
            </div>
        </div>
    `;
}

// ADICIONAR FUNÇÃO PARA ATUALIZAR AUTOMATICAMENTE O PERÍODO DE VENDAS POR HORA
function initializeChartPeriods() {
    // Definir período padrão para hoje
    const salesHoursPeriod = document.getElementById('salesHoursPeriod');
    if (salesHoursPeriod) {
        salesHoursPeriod.value = 'today';
    }
}

// FUNÇÃO PARA FORMATAR PERÍODO PARA EXIBIÇÃO
function formatPeriodDisplay(startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    const sameDay = start.toDateString() === end.toDateString();
    
    if (sameDay) {
        return start.toLocaleDateString('pt-BR');
    } else {
        return `${start.toLocaleDateString('pt-BR')} - ${end.toLocaleDateString('pt-BR')}`;
    }
}

// ADICIONAR INDICADOR DE PERÍODO ATUAL NO DASHBOARD
function updatePeriodIndicator(startDate, endDate) {
    // Criar ou atualizar indicador de período
    let indicator = document.getElementById('currentPeriodIndicator');
    
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'currentPeriodIndicator';
        indicator.className = 'bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium';
        
        // Inserir após os filtros
        const filterContainer = document.querySelector('.filter-chip').parentElement;
        if (filterContainer) {
            filterContainer.appendChild(indicator);
        }
    }
    
    indicator.innerHTML = `
        <i class="fas fa-calendar-alt mr-1"></i>
        ${formatPeriodDisplay(startDate, endDate)}
    `;
}

            // Inicialização
            setupTabs();
            setupPeriodFilters();
            setupKPIModals();
            setupEventListeners();

             const btnFechamento = document.getElementById('btnFechamento');
                if (btnFechamento) {
                 btnFechamento.addEventListener('click', () => {
            window.location.pathname = '/fechamento';
        });
    }
            
            // Carregar dados iniciais
            loadDashboardData();
            
            // Auto-refresh a cada 5 minutos
            setInterval(() => {
                loadDashboardData();
                showToast('Dashboard atualizado automaticamente', 'info', 3000);
            }, 300000);
        });
    </script>
    
    <!-- Script de correção para exibição de preços -->
    <script>
        // price-manager-fix.js - Script para corrigir a exibição de preços na interface administrativa
        document.addEventListener('DOMContentLoaded', () => {
            console.log("🔧 Inicializando correção de exibição de preços...");
            
            // Classe aprimorada para gerenciamento de preços
            class EnhancedPriceManager {
                constructor() {
                    this.containers = {
                        precosPasteisContainer: document.getElementById('precosPasteisContainer'),
                        precosCasquinhasContainer: document.getElementById('precosCasquinhasContainer'), 
                        precosCaldoCanaContainer: document.getElementById('precosCaldoCanaContainer'),
                        precosRefrigerantesContainer: document.getElementById('precosRefrigerantesContainer'),
                        precosGeloContainer: document.getElementById('precosGeloContainer')
                    };
                    
                    // Verificar containers e criar se não existirem
                    Object.entries(this.containers).forEach(([key, container]) => {
                        if (!container) {
                            console.warn(`⚠️ Container ${key} não encontrado, criando elemento...`);
                            
                            // Encontrar o fieldset pai pelo nome
                            const category = key.replace('precos', '').replace('Container', '');
                            const fieldset = document.querySelector(`fieldset:has(legend:contains('${category}'))`);
                            
                            if (fieldset) {
                                // Criar container se o fieldset existir
                                const newContainer = document.createElement('div');
                                newContainer.id = key;
                                newContainer.className = 'prices-grid';
                                
                                // Encontrar onde inserir (após o texto de contagem)
                                const countDiv = fieldset.querySelector('.flex.items-center.justify-between');
                                if (countDiv) {
                                    countDiv.insertAdjacentElement('afterend', newContainer);
                                    this.containers[key] = newContainer;
                                }
                            }
                        }
                    });
                    
                    // Mapeamento para nomes no Firebase
                    this.firebaseCategoryMap = {
                        pasteis: 'pasteis',
                        casquinhas: 'casquinhas',
                        caldo_cana: 'caldo_cana',
                        refrigerantes: 'refrigerantes',
                        gelo: 'gelo'
                    };
                    
                    // Lista de produtos por categoria
                    this.produtosPorCategoria = {
                        pasteis: [
                            "carne", "frango", "queijo", "pizza", "bauru", "calabresa", "palmito",
                            "especial_de_carne", "especial_de_frango", "especial_de_calabresa"
                        ],
                        casquinhas: [
                            "casquinha_simples", "casquinha_com_cobertura", "casquinha_com_granulado"
                        ],
                        caldo_cana: [
                            "caldo_de_cana_300ml", "caldo_de_cana_500ml", "caldo_de_cana_700ml", "caldo_de_cana_1litro"
                        ],
                        refrigerantes: [
                            "coca_cola_350ml", "coca_cola_600ml", "coca_cola_2l", "guarana_350ml", "guarana_600ml", 
                            "guarana_2l", "fanta_laranja_350ml", "fanta_laranja_600ml", "fanta_laranja_2l", "fanta_uva_350ml", 
                            "sprite_350ml", "agua_mineral_500ml"
                        ],
                        gelo: ["gelo_pacote"]
                    };
                    
                    // Mapeamento de container para categoria
                    this.containerToCategoryMap = {
                        precosPasteisContainer: 'pasteis',
                        precosCasquinhasContainer: 'casquinhas',
                        precosCaldoCanaContainer: 'caldo_cana',
                        precosRefrigerantesContainer: 'refrigerantes',
                        precosGeloContainer: 'gelo'
                    };
                    
                    // Armazenar preços atuais
                    this.currentPrices = {};
                }

                async load() {
                    console.log("🔄 Iniciando carregamento de preços aprimorado...");
                    this.showLoadingState();
                    
                    try {
                        // Verificar se já temos preços armazenados
                        if (window.appState && window.appState.currentPrices && 
                            Object.keys(window.appState.currentPrices).length > 0) {
                            console.log("✅ Usando preços do estado da aplicação");
                            this.currentPrices = window.appState.currentPrices;
                        } else {
                            // Carregar preços do Firebase
                            console.log("🔍 Buscando preços no Firebase...");
                            const precos = await this.fetchPrices();
                            this.currentPrices = precos;
                            
                            // Armazenar no estado global
                            if (window.appState) {
                                window.appState.currentPrices = precos;
                            } else {
                                window.appState = { currentPrices: precos };
                            }
                        }
                        
                        // Preencher formulários
                        this.populateForms();
                        this.setupFormHandler();
                        this.updateCounters();
                        
                        // Exibir mensagem de sucesso
                        this.showSuccessMessage("Preços carregados com sucesso!");
                        
                    } catch (error) {
                        console.error("❌ Erro ao carregar preços:", error);
                        this.showErrorMessage(`Erro ao carregar preços: ${error.message}`);
                        
                        // Fallback para preços padrão
                        this.populateWithDefaults();
                    }
                }

                showLoadingState() {
                    Object.values(this.containers).forEach(container => {
                        if (container) {
                            container.innerHTML = '<div class="text-center p-8 text-gray-500"><i class="fas fa-spinner fa-spin text-2xl mb-3"></i><p>Carregando preços...</p></div>';
                        }
                    });
                }

                showSuccessMessage(message) {
                    if (window.notifications && typeof window.notifications.showMessage === 'function') {
                        window.notifications.showMessage(message, "success");
                    } else {
                        console.log(`✅ ${message}`);
                        // Criar uma notificação temporária
                        const toast = document.createElement('div');
                        toast.className = 'fixed top-4 right-4 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded shadow-md z-50';
                        toast.innerHTML = `<div class="flex items-center"><i class="fas fa-check-circle mr-2"></i>${message}</div>`;
                        document.body.appendChild(toast);
                        setTimeout(() => toast.remove(), 3000);
                    }
                }

                showErrorMessage(message) {
                    if (window.notifications && typeof window.notifications.showMessage === 'function') {
                        window.notifications.showMessage(message, "error");
                    } else {
                        console.error(`❌ ${message}`);
                        // Criar uma notificação de erro
                        const toast = document.createElement('div');
                        toast.className = 'fixed top-4 right-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-md z-50';
                        toast.innerHTML = `<div class="flex items-center"><i class="fas fa-exclamation-circle mr-2"></i>${message}</div>`;
                        document.body.appendChild(toast);
                        setTimeout(() => toast.remove(), 5000);
                    }
                }

                async fetchPrices() {
                    console.log("🔍 Buscando preços no Firebase...");
                    
                    // Verificar se temos acesso ao Firestore
                    if (!window.db) {
                        throw new Error("Firestore não está disponível. Verifique a conexão com o Firebase.");
                    }
                    
                    const precos = {};
                    
                    // Criar e usar preços padrão se estiver offline
                    if (!navigator.onLine) {
                        console.warn("⚠️ Dispositivo offline. Usando preços padrão.");
                        return this.getDefaultPrices();
                    }
                    
                    try {
                        // Para cada categoria, buscar o documento correto no Firebase
                        for (const [categoriaLocal, categoriaFirebase] of Object.entries(this.firebaseCategoryMap)) {
                            console.log(`📂 Buscando produtos da categoria: ${categoriaLocal} -> ${categoriaFirebase}`);
                            precos[categoriaLocal] = {};
                            
                            try {
                                // Buscar diretamente o documento da categoria
                                const categoriaDoc = await db.collection('produtos').doc(categoriaFirebase).get();
                                
                                if (categoriaDoc.exists) {
                                    const data = categoriaDoc.data();
                                    console.log(`📄 Dados encontrados no documento ${categoriaFirebase}:`, data);
                                    
                                    // Extrair preços do documento
                                    Object.keys(data).forEach(key => {
                                        // Os preços estão armazenados como números
                                        if (typeof data[key] === 'number') {
                                            precos[categoriaLocal][key] = { preco: data[key] };
                                            console.log(`  ✓ ${key}: R$ ${data[key]}`);
                                        }
                                    });
                                } else {
                                    console.warn(`⚠️ Documento '${categoriaFirebase}' não encontrado na coleção 'produtos'`);
                                    
                                    // Criar documento se não existir
                                    await this.createDefaultCategoryDocument(categoriaFirebase);
                                    
                                    // Usar preços padrão para esta categoria
                                    const defaultPrices = this.getDefaultPrices();
                                    precos[categoriaLocal] = defaultPrices[categoriaLocal];
                                }
                            } catch (error) {
                                console.error(`❌ Erro ao buscar categoria ${categoriaFirebase}:`, error);
                                // Usar preços padrão para esta categoria em caso de erro
                                const defaultPrices = this.getDefaultPrices();
                                precos[categoriaLocal] = defaultPrices[categoriaLocal];
                            }
                        }
                        
                        // Verificar se encontramos preços
                        let totalProdutos = 0;
                        Object.values(precos).forEach(categoria => {
                            totalProdutos += Object.keys(categoria).length;
                        });
                        
                        console.log(`📊 Total de produtos com preços: ${totalProdutos}`);
                        
                        if (totalProdutos === 0) {
                            throw new Error("Nenhum produto com preço foi encontrado no banco de dados");
                        }
                        
                        return precos;
                        
                    } catch (error) {
                        console.error("❌ Erro ao buscar preços:", error);
                        throw error;
                    }
                }

                async createDefaultCategoryDocument(categoryKey) {
                    if (!navigator.onLine) return false;
                    
                    try {
                        console.log(`🔨 Criando documento padrão para categoria: ${categoryKey}`);
                        
                        const defaultPrices = this.getDefaultPrices();
                        const categoryLocalKey = Object.keys(this.firebaseCategoryMap).find(
                            key => this.firebaseCategoryMap[key] === categoryKey
                        );
                        
                        if (!categoryLocalKey || !defaultPrices[categoryLocalKey]) {
                            console.error(`❌ Não foi possível encontrar preços padrão para categoria ${categoryKey}`);
                            return false;
                        }
                        
                        // Converter de { itemKey: { preco: value } } para { itemKey: value }
                        const defaultPriceData = {};
                        Object.entries(defaultPrices[categoryLocalKey]).forEach(([key, data]) => {
                            defaultPriceData[key] = data.preco;
                        });
                        
                        // Criar documento no Firebase
                        await db.collection('produtos').doc(categoryKey).set(defaultPriceData);
                        console.log(`✅ Documento criado com sucesso para ${categoryKey}`);
                        return true;
                        
                    } catch (error) {
                        console.error(`❌ Erro ao criar documento para ${categoryKey}:`, error);
                        return false;
                    }
                }

                populateForms() {
                    Object.entries(this.containers).forEach(([containerId, container]) => {
                        if (!container) return;
                        
                        const categoryKey = this.containerToCategoryMap[containerId];
                        if (!categoryKey) return;
                        
                        const products = this.produtosPorCategoria[categoryKey] || [];
                        
                        container.innerHTML = '';
                        
                        if (products.length === 0) {
                            container.innerHTML = '<div class="text-center p-4 text-gray-500">Nenhum produto nesta categoria</div>';
                            return;
                        }
                        
                        console.log(`📋 Populando ${products.length} produtos na categoria ${categoryKey}`);
                        
                        products.forEach(product => {
                            const itemKey = product; // Já está no formato correto
                            
                            // Buscar preço no estado da aplicação
                            let currentPrice = 0;
                            
                            if (this.currentPrices[categoryKey] && 
                                this.currentPrices[categoryKey][itemKey] && 
                                this.currentPrices[categoryKey][itemKey].preco !== undefined) {
                                currentPrice = this.currentPrices[categoryKey][itemKey].preco;
                            }
                            
                            console.log(`  - Produto: ${product}, Key: ${itemKey}, Preço: ${currentPrice}`);
                            
                            // Formatar nome para exibição
                            const displayName = this.formatProductName(product);
                            
                            const priceCard = this.createPriceCard(displayName, categoryKey, itemKey, currentPrice);
                            container.appendChild(priceCard);
                        });
                    });
                }

                formatProductName(productKey) {
                    return productKey
                        .replace(/_/g, ' ')
                        .replace(/\b\w/g, l => l.toUpperCase())
                        .replace(/De /g, 'de ')
                        .replace(/Com /g, 'com ')
                        .replace(/\d+ml/g, match => match.toUpperCase())
                        .replace(/\d+l/g, match => match.toUpperCase());
                }

                updateCounters() {
                    Object.entries(this.containerToCategoryMap).forEach(([containerId, categoryKey]) => {
                        const categoryId = containerId.replace('precos', '').replace('Container', '');
                        
                        // Tentar diferentes possibilidades de ID para o contador
                        const possibleIds = [
                            `${categoryKey}Count`,
                            `${categoryKey.replace('_', '')}Count`,
                            `${categoryId}Count`,
                            `${categoryId.toLowerCase()}Count`
                        ];
                        
                        let counterElement = null;
                        
                        for (const id of possibleIds) {
                            const element = document.getElementById(id);
                            if (element) {
                                counterElement = element;
                                break;
                            }
                        }
                        
                        if (counterElement) {
                            const products = this.produtosPorCategoria[categoryKey] || [];
                            counterElement.textContent = products.length;
                            console.log(`📊 Contador ${counterElement.id}: ${products.length} produtos`);
                        } else {
                            console.warn(`⚠️ Contador não encontrado para categoria ${categoryKey}`);
                        }
                    });
                }

                createPriceCard(itemDisplayName, categoryKey, itemKey, currentPriceValue) {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'price-card bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:shadow-lg hover:border-primary-200 transition-all duration-300 transform hover:-translate-y-1';
                    
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'flex items-center justify-between mb-4';
                    
                    const productIcon = document.createElement('div');
                    productIcon.className = 'w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center';
                    
                    const iconClass = this.getProductIcon(categoryKey);
                    productIcon.innerHTML = `<i class="${iconClass} text-primary-600"></i>`;
                    
                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'flex-1 ml-3';
                    
                    const label = document.createElement('h3');
                    label.className = 'text-sm font-semibold text-gray-800 mb-1';
                    label.textContent = itemDisplayName;
                    
                    const keyLabel = document.createElement('p');
                    keyLabel.className = 'text-xs text-gray-500';
                    keyLabel.textContent = `ID: ${itemKey}`;
                    
                    titleDiv.appendChild(label);
                    titleDiv.appendChild(keyLabel);
                    headerDiv.appendChild(productIcon);
                    headerDiv.appendChild(titleDiv);
                    
                    const inputContainer = document.createElement('div');
                    inputContainer.className = 'relative mb-4';
                    
                    const inputLabel = document.createElement('label');
                    inputLabel.htmlFor = `preco_${categoryKey}_${itemKey}`;
                    inputLabel.className = 'block text-sm font-medium text-gray-700 mb-2';
                    inputLabel.innerHTML = '<i class="fas fa-dollar-sign mr-1 text-primary-500"></i>Preço Unitário';
                    
                    const inputWrapper = document.createElement('div');
                    inputWrapper.className = 'relative';
                    
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.id = `preco_${categoryKey}_${itemKey}`;
                    input.name = `preco_${categoryKey}_${itemKey}`;
                    input.step = '0.01';
                    input.min = '0';
                    input.required = true;
                    input.className = 'w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 text-lg font-semibold';
                    input.value = parseFloat(currentPriceValue).toFixed(2);
                    input.placeholder = '0.00';
                    input.dataset.categoryKey = categoryKey;
                    input.dataset.itemKey = itemKey;
                    input.dataset.originalValue = parseFloat(currentPriceValue).toFixed(2);
                    
                    const currencySymbol = document.createElement('div');
                    currencySymbol.className = 'absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-semibold text-lg';
                    currencySymbol.textContent = 'R$';
                    
                    const changeIndicator = document.createElement('div');
                    changeIndicator.className = 'absolute right-3 top-1/2 transform -translate-y-1/2 opacity-0 transition-opacity duration-200';
                    changeIndicator.innerHTML = '<i class="fas fa-check text-success-500 text-lg"></i>';
                    
                    inputWrapper.appendChild(currencySymbol);
                    inputWrapper.appendChild(input);
                    inputWrapper.appendChild(changeIndicator);
                    
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'bg-gray-50 p-3 rounded-lg';
                    
                    const currentValueDiv = document.createElement('div');
                    currentValueDiv.className = 'flex items-center justify-between text-sm';
                    
                    const currentLabel = document.createElement('span');
                    currentLabel.className = 'text-gray-600';
                    currentLabel.textContent = 'Valor atual:';
                    
                    const currentValueSpan = document.createElement('span');
                    currentValueSpan.className = 'font-bold text-primary-600 text-lg';
                    currentValueSpan.textContent = this.formatCurrency(currentPriceValue);
                    
                    currentValueDiv.appendChild(currentLabel);
                    currentValueDiv.appendChild(currentValueSpan);
                    infoDiv.appendChild(currentValueDiv);
                    
                    // Event listeners
                    input.addEventListener('input', () => {
                        const newValue = parseFloat(input.value) || 0;
                        currentValueSpan.textContent = this.formatCurrency(newValue);
                        
                        const originalValue = parseFloat(input.dataset.originalValue);
                        if (Math.abs(newValue - originalValue) > 0.01) {
                            changeIndicator.classList.remove('opacity-0');
                            cardDiv.classList.add('ring-2', 'ring-primary-200', 'bg-primary-50');
                        } else {
                            changeIndicator.classList.add('opacity-0');
                            cardDiv.classList.remove('ring-2', 'ring-primary-200', 'bg-primary-50');
                        }
                    });
                    
                    input.addEventListener('focus', () => {
                        cardDiv.classList.add('ring-2', 'ring-primary-300');
                    });
                    
                    input.addEventListener('blur', () => {
                        cardDiv.classList.remove('ring-2', 'ring-primary-300');
                    });
                    
                    inputContainer.appendChild(inputLabel);
                    inputContainer.appendChild(inputWrapper);
                    
                    cardDiv.appendChild(headerDiv);
                    cardDiv.appendChild(inputContainer);
                    cardDiv.appendChild(infoDiv);
                    
                    return cardDiv;
                }

                getProductIcon(categoryKey) {
                    const icons = {
                        pasteis: 'fas fa-utensils',
                        casquinhas: 'fas fa-ice-cream',
                        caldo_cana: 'fas fa-glass-whiskey',
                        refrigerantes: 'fas fa-bottle-water',
                        gelo: 'fas fa-cube'
                    };
                    return icons[categoryKey] || 'fas fa-tag';
                }

                setupFormHandler() {
                    const form = document.getElementById('formPrecos');
                    const resetBtn = document.getElementById('resetPricesBtn');
                    
                    if (!form) {
                        console.warn("⚠️ Formulário 'formPrecos' não encontrado");
                        return;
                    }
                    
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await this.saveAll();
                    });
                    
                    if (resetBtn) {
                        resetBtn.addEventListener('click', () => {
                            this.resetPrices();
                        });
                    } else {
                        console.warn("⚠️ Botão 'resetPricesBtn' não encontrado");
                    }
                }

                resetPrices() {
                    const inputs = document.querySelectorAll('#formPrecos input[type="number"]');
                    
                    inputs.forEach(input => {
                        const originalValue = input.dataset.originalValue;
                        if (originalValue) {
                            input.value = originalValue;
                            input.dispatchEvent(new Event('input'));
                        }
                    });
                    
                    this.showSuccessMessage('Preços resetados para valores originais');
                }

                async saveAll() {
                    const saveButton = document.querySelector('#formPrecos button[type="submit"]');
                    if (!saveButton) {
                        this.showErrorMessage('Botão de salvar não encontrado');
                        return;
                    }
                    
                    const originalText = saveButton.innerHTML;
                    
                    try {
                        saveButton.disabled = true;
                        saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando preços...';
                        
                        // Verificar conexão
                        if (!navigator.onLine) {
                            throw new Error("Você está offline. Não é possível salvar alterações.");
                        }
                        
                        // Verificar se Firestore está disponível
                        if (!window.db) {
                            throw new Error("Firestore não está disponível. Verifique a conexão com o Firebase.");
                        }
                        
                        const newPricesData = {};
                        const inputs = document.querySelectorAll('#formPrecos input[type="number"]');
                        let hasError = false;
                        let changedCount = 0;
                        
                        // Coletar todos os preços alterados
                        const updatesByCategory = {};
                        
                        inputs.forEach(input => {
                            const category = input.dataset.categoryKey;
                            const item = input.dataset.itemKey;
                            
                            if (!category || !item) {
                                console.warn('Input sem categoria ou item key:', input);
                                return;
                            }
                            
                            const price = parseFloat(input.value);
                            
                            if (isNaN(price) || price < 0) {
                                input.classList.add('border-danger-500', 'bg-danger-50');
                                hasError = true;
                                return;
                            }
                            
                            input.classList.remove('border-danger-500', 'bg-danger-50');
                            
                            // Verificar se o preço mudou
                            const categoryData = this.currentPrices[category] || {};
                            const itemData = categoryData[item] || {};
                            const currentPrice = itemData.preco || 0;
                            
                            if (Math.abs(price - currentPrice) > 0.01) {
                                changedCount++;
                                
                                // Agrupar por categoria e usar o nome correto do Firebase
                                const firebaseCategory = this.firebaseCategoryMap[category] || category;
                                if (!updatesByCategory[firebaseCategory]) {
                                    updatesByCategory[firebaseCategory] = {};
                                }
                                // Salvar diretamente como campo, não como objeto
                                updatesByCategory[firebaseCategory][item] = price;
                            }
                            
                            // Adicionar à estrutura de dados para salvar
                            if (!newPricesData[category]) {
                                newPricesData[category] = {};
                            }
                            
                            newPricesData[category][item] = { preco: price };
                        });
                        
                        if (hasError) {
                            throw new Error('Alguns preços são inválidos. Verifique os campos destacados em vermelho.');
                        }
                        
                        if (changedCount === 0) {
                            this.showSuccessMessage('Nenhuma alteração foi detectada nos preços.');
                            saveButton.disabled = false;
                            saveButton.innerHTML = originalText;
                            return;
                        }
                        
                        console.log('Salvando novos preços:', updatesByCategory);
                        console.log(`${changedCount} itens alterados`);
                        
                        // Salvar no Firebase na estrutura correta (campos diretos no documento)
                        const batch = db.batch();
                        
                        for (const [category, updates] of Object.entries(updatesByCategory)) {
                            const docRef = db.collection('produtos').doc(category);
                            batch.update(docRef, updates);
                        }
                        
                        await batch.commit();
                        console.log("✅ Preços salvos com sucesso no Firebase");
                        
                        // Atualizar o estado local
                        Object.keys(newPricesData).forEach(categoryKey => {
                            if (!this.currentPrices[categoryKey]) {
                                this.currentPrices[categoryKey] = {};
                            }
                            
                            Object.keys(newPricesData[categoryKey]).forEach(itemKey => {
                                if (!this.currentPrices[categoryKey][itemKey]) {
                                    this.currentPrices[categoryKey][itemKey] = {};
                                }
                                
                                this.currentPrices[categoryKey][itemKey].preco = 
                                    newPricesData[categoryKey][itemKey].preco;
                            });
                        });
                        
                        // Atualizar o estado global
                        if (window.appState) {
                            window.appState.currentPrices = this.currentPrices;
                        }
                        
                        // Atualizar valores originais nos inputs
                        inputs.forEach(input => {
                            const category = input.dataset.categoryKey;
                            const item = input.dataset.itemKey;
                            
                            if (category && item && newPricesData[category] && newPricesData[category][item]) {
                                input.dataset.originalValue = newPricesData[category][item].preco.toFixed(2);
                            }
                        });
                        
                        // Efeito visual de sucesso
                        inputs.forEach(input => {
                            const card = input.closest('.price-card');
                            if (card) {
                                card.classList.remove('ring-2', 'ring-primary-200', 'bg-primary-50');
                                card.classList.add('ring-2', 'ring-success-200', 'bg-success-50');
                                
                                setTimeout(() => {
                                    card.classList.remove('ring-2', 'ring-success-200', 'bg-success-50');
                                }, 2000);
                            }
                        });
                        
                        // Mostrar mensagem de sucesso
                        const mensagemSucesso = document.getElementById('precosSalvosMsg');
                        if (mensagemSucesso) {
                            mensagemSucesso.classList.remove('hidden');
                            setTimeout(() => {
                                mensagemSucesso.classList.add('hidden');
                            }, 3000);
                        }
                        
                        this.showSuccessMessage(`${changedCount} preço(s) alterado(s) com sucesso!`);
                        
                    } catch (error) {
                        console.error("❌ Erro ao salvar preços:", error);
                        
                        // Mostrar mensagem de erro
                        const mensagemErro = document.getElementById('precosErrorMsg');
                        if (mensagemErro) {
                            mensagemErro.classList.remove('hidden');
                            setTimeout(() => {
                                mensagemErro.classList.add('hidden');
                            }, 3000);
                        }
                        
                        this.showErrorMessage('Erro ao salvar preços: ' + error.message);
                        
                    } finally {
                        saveButton.disabled = false;
                        saveButton.innerHTML = originalText;
                    }
                }

                getDefaultPrices() {
                    return {
                        pasteis: {
                            carne: { preco: 8.00 },
                            frango: { preco: 8.00 },
                            queijo: { preco: 8.00 },
                            pizza: { preco: 8.00 },
                            bauru: { preco: 8.00 },
                            calabresa: { preco: 8.00 },
                            palmito: { preco: 8.00 },
                            especial_de_carne: { preco: 10.00 },
                            especial_de_frango: { preco: 10.00 },
                            especial_de_calabresa: { preco: 10.00 }
                        },
                        casquinhas: {
                            casquinha_simples: { preco: 3.00 },
                            casquinha_com_cobertura: { preco: 4.00 },
                            casquinha_com_granulado: { preco: 4.50 }
                        },
                        caldo_cana: {
                            caldo_de_cana_300ml: { preco: 5.00 },
                            caldo_de_cana_500ml: { preco: 7.00 },
                            caldo_de_cana_700ml: { preco: 9.00 },
                            caldo_de_cana_1litro: { preco: 12.00 }
                        },
                        refrigerantes: {
                            coca_cola_350ml: { preco: 5.00 },
                            coca_cola_600ml: { preco: 7.00 },
                            coca_cola_2l: { preco: 12.00 },
                            guarana_350ml: { preco: 5.00 },
                            guarana_600ml: { preco: 7.00 },
                            guarana_2l: { preco: 12.00 },
                            fanta_laranja_350ml: { preco: 5.00 },
                            fanta_laranja_600ml: { preco: 7.00 },
                            fanta_laranja_2l: { preco: 12.00 },
                            fanta_uva_350ml: { preco: 5.00 },
                            sprite_350ml: { preco: 5.00 },
                            agua_mineral_500ml: { preco: 3.00 }
                        },
                        gelo: {
                            gelo_pacote: { preco: 5.00 }
                        }
                    };
                }

                formatCurrency(value) {
                    const valueNumber = parseFloat(value);
                    if (isNaN(valueNumber)) return 'R$ 0,00';
                    
                    return `R$ ${valueNumber.toFixed(2).replace('.', ',')}`;
                }

                populateWithDefaults() {
                    const defaultPrices = this.getDefaultPrices();
                    this.currentPrices = defaultPrices;
                    
                    // Atualizar o estado global
                    if (window.appState) {
                        window.appState.currentPrices = defaultPrices;
                    } else {
                        window.appState = { currentPrices: defaultPrices };
                    }
                    
                    this.populateForms();
                    this.updateCounters();
                    this.showWarningMessage("Usando preços padrão. As alterações não serão salvas até que a conexão seja restaurada.");
                }

                showWarningMessage(message) {
                    if (window.notifications && typeof window.notifications.showMessage === 'function') {
                        window.notifications.showMessage(message, "warning");
                    } else {
                        console.warn(`⚠️ ${message}`);
                        // Criar uma notificação temporária
                        const toast = document.createElement('div');
                        toast.className = 'fixed top-4 right-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded shadow-md z-50';
                        toast.innerHTML = `<div class="flex items-center"><i class="fas fa-exclamation-triangle mr-2"></i>${message}</div>`;
                        document.body.appendChild(toast);
                        setTimeout(() => toast.remove(), 5000);
                    }
                }
            }

            // Corrigir a função loadPricesData no objeto window
            window.loadPricesData = async function() {
                console.log("🔄 Iniciando loadPricesData() aprimorado...");
                
                try {
                    // Criar uma instância do gerenciador de preços aprimorado
                    const enhancedPriceManager = new EnhancedPriceManager();
                    
                    // Armazenar globalmente para acesso futuro
                    window.enhancedPriceManager = enhancedPriceManager;
                    
                    // Carregar preços
                    await enhancedPriceManager.load();
                    
                    return true;
                } catch (error) {
                    console.error("❌ Erro ao carregar dados de preços:", error);
                    
                    // Mostrar notificação de erro
                    if (window.notifications && typeof window.notifications.showMessage === 'function') {
                        window.notifications.showMessage(`Erro ao carregar preços: ${error.message}`, "error");
                    } else {
                        alert(`Erro ao carregar preços: ${error.message}`);
                    }
                    
                    return false;
                }
            };

            // Corrigir a ativação da aba de preços
            const btnTabPrecos = document.getElementById('btnTabPrecos');
            if (btnTabPrecos) {
                // Substituir o event listener existente
                const newClickHandler = async function() {
                    // Ativar visualmente a aba
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('active', 'bg-primary-500', 'text-white', 'font-semibold');
                        btn.classList.add('bg-gray-200', 'text-gray-700', 'font-medium');
                    });
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    btnTabPrecos.classList.remove('bg-gray-200', 'text-gray-700', 'font-medium');
                    btnTabPrecos.classList.add('active', 'bg-primary-500', 'text-white', 'font-semibold');
                    
                    const tabContentPrecos = document.getElementById('tabContentPrecos');
                    if (tabContentPrecos) {
                        tabContentPrecos.classList.remove('hidden');
                    }
                    
                    // Carregar os dados de preços
                    await window.loadPricesData();
                };
                
                // Remover listeners existentes (técnica para evitar duplicação)
                btnTabPrecos.removeEventListener('click', newClickHandler);
                btnTabPrecos.addEventListener('click', newClickHandler);
            }

            // Verificar se estamos na aba de preços ao carregar a página
            const isTabPrecosActive = document.querySelector('#btnTabPrecos.active');
            if (isTabPrecosActive) {
                // Se já estamos na aba de preços, carregar os dados
                window.loadPricesData();
            }

            console.log("✅ Correção de exibição de preços inicializada com sucesso!");
        });
    </script>
    
    <!-- Script para carregamento de admin-controller.js -->

    <script src="src/js/admin-controller.js"></script>
</body>
</html>