<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Administrativo - Pastelaria 24h</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="src/css/style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .kpi-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.5);
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .severity-critical { border-left: 4px solid #dc2626; background: #fef2f2; }
        .severity-warning { border-left: 4px solid #f59e0b; background: #fffbeb; }
        .severity-info { border-left: 4px solid #3b82f6; background: #eff6ff; }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .timeline-item {
            position: relative;
            padding-left: 2rem;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0.5rem;
            width: 0.5rem;
            height: 0.5rem;
            background: #3b82f6;
            border-radius: 50%;
        }
        
        .timeline-item::after {
            content: '';
            position: absolute;
            left: 0.75rem;
            top: 1rem;
            width: 1px;
            height: calc(100% - 1rem);
            background: #e5e7eb;
        }
        
        .timeline-item:last-child::after {
            display: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 50;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: white;
            border-radius: 1rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        
        .filter-chip {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            background: #f3f4f6;
            border-radius: 9999px;
            font-size: 0.875rem;
            margin: 0.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .filter-chip.active {
            background: #3b82f6;
            color: white;
        }
        
        .filter-chip:hover {
            background: #e5e7eb;
        }
        
        .filter-chip.active:hover {
            background: #2563eb;
        }
    </style>
</head>
<body>
    <div class="min-h-screen">
        <header class="glass-card sticky top-0 z-40 border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-r from-orange-500 to-red-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chart-line text-white text-lg"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-white">Pastelaria 24h</h1>
                            <p class="text-sm text-gray-200">Dashboard Administrativo</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <button id="notificationBtn" class="text-white hover:text-gray-200 relative">
                                <i class="fas fa-bell text-xl"></i>
                                <span id="notificationBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                            </button>
                        </div>
                        
                        <div class="flex items-center space-x-3 px-3 py-2 rounded-lg glass-card">
                            <i class="fas fa-user-shield text-white"></i>
                            <span id="loggedInUserName" class="text-white font-medium">Admin</span>
                        </div>
                        
                        <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Sair</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="mb-8">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-white mb-2">Dashboard Operacional</h2>
                        <p class="text-gray-200">Vis√£o completa do desempenho da sua pastelaria</p>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-3 mt-4 lg:mt-0">
                        <div class="flex items-center space-x-2 glass-card px-4 py-2 rounded-lg">
                            <i class="fas fa-calendar text-white"></i>
                            <select id="periodSelector" class="bg-transparent text-white border-none outline-none">
                                <option value="today">Hoje</option>
                                <option value="yesterday">Ontem</option>
                                <option value="week">Esta Semana</option>
                                <option value="month">Este M√™s</option>
                                <option value="custom">Per√≠odo Personalizado</option>
                            </select>
                        </div>
                        
                        <div id="customDateRange" class="hidden flex items-center space-x-2">
                            <input type="date" id="startDate" class="glass-card text-white border-none rounded-lg px-3 py-2">
                            <span class="text-white">at√©</span>
                            <input type="date" id="endDate" class="glass-card text-white border-none rounded-lg px-3 py-2">
                        </div>
                        
                        <button id="refreshData" class="glass-card px-4 py-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20 transition-colors">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        
                        <button id="exportData" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg text-white transition-colors">
                            <i class="fas fa-download mr-2"></i>Exportar
                        </button>
                    </div>
                </div>

                <div class="flex flex-wrap gap-2 mb-6">
                    <div class="filter-chip" data-filter="turno">
                        <i class="fas fa-clock mr-2"></i>Filtrar por Turno
                    </div>
                    <div class="filter-chip" data-filter="pagamento">
                        <i class="fas fa-credit-card mr-2"></i>Forma de Pagamento
                    </div>
                    <div class="filter-chip" data-filter="produto">
                        <i class="fas fa-utensils mr-2"></i>Produto
                    </div>
                    <div class="filter-chip" data-filter="funcionario">
                        <i class="fas fa-user mr-2"></i>Funcion√°rio
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6 mb-8">
                <div class="kpi-card glass-card rounded-xl p-6 text-white" data-kpi="vendas">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-dollar-sign text-xl"></i>
                        </div>
                        <span class="text-green-400 text-sm font-medium">+12.5%</span>
                    </div>
                    <div class="space-y-1">
                        <p class="text-gray-300 font-medium">Vendas Brutas</p>
                        <p id="kpi-vendas" class="text-2xl font-bold">R$ 0,00</p>
                    </div>
                </div>

                <div class="kpi-card glass-card rounded-xl p-6 text-white" data-kpi="ticket">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-receipt text-xl"></i>
                        </div>
                        <span class="text-blue-400 text-sm font-medium">+8.3%</span>
                    </div>
                    <div class="space-y-1">
                        <p class="text-gray-300 font-medium">Ticket M√©dio</p>
                        <p id="kpi-ticket" class="text-2xl font-bold">R$ 0,00</p>
                    </div>
                </div>

                <div class="kpi-card glass-card rounded-xl p-6 text-white" data-kpi="pedidos">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-purple-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-shopping-cart text-xl"></i>
                        </div>
                        <span class="text-purple-400 text-sm font-medium">+15.2%</span>
                    </div>
                    <div class="space-y-1">
                        <p class="text-gray-300 font-medium">Total Pedidos</p>
                        <p id="kpi-pedidos" class="text-2xl font-bold">0</p>
                    </div>
                </div>

                <div class="kpi-card glass-card rounded-xl p-6 text-white" data-kpi="divergencias">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-red-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-xl"></i>
                        </div>
                        <span class="text-red-400 text-sm font-medium">-2.1%</span>
                    </div>
                    <div class="space-y-1">
                        <p class="text-gray-300 font-medium">% Diverg√™ncias</p>
                        <p id="kpi-divergencias" class="text-2xl font-bold">0%</p>
                    </div>
                </div>

                <div class="kpi-card glass-card rounded-xl p-6 text-white" data-kpi="caixa">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-yellow-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-cash-register text-xl"></i>
                        </div>
                        <span class="text-yellow-400 text-sm font-medium">atual</span>
                    </div>
                    <div class="space-y-1">
                        <p class="text-gray-300 font-medium">Caixa Atual</p>
                        <p id="kpi-caixa" class="text-2xl font-bold">R$ 0,00</p>
                    </div>
                </div>

                <div class="kpi-card glass-card rounded-xl p-6 text-white" data-kpi="lucro">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-indigo-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chart-line text-xl"></i>
                        </div>
                        <span class="text-indigo-400 text-sm font-medium">+18.7%</span>
                    </div>
                    <div class="space-y-1">
                        <p class="text-gray-300 font-medium">Lucro Estimado</p>
                        <p id="kpi-lucro" class="text-2xl font-bold">R$ 0,00</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="glass-card rounded-xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-white">Vendas por Forma de Pagamento</h3>
                        <button class="text-gray-300 hover:text-white">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    <div class="chart-container">
                        <canvas id="paymentChart"></canvas>
                    </div>
                </div>

                <div class="glass-card rounded-xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-white">Top 10 Produtos</h3>
                        <button class="text-gray-300 hover:text-white">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    <div class="chart-container">
                        <canvas id="productsChart"></canvas>
                    </div>
                </div>

                <div class="glass-card rounded-xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-white">Vendas por Hora</h3>
                        <button class="text-gray-300 hover:text-white">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    <div class="chart-container">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>

                <div class="glass-card rounded-xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-white">Heatmap de Diverg√™ncias</h3>
                        <button class="text-gray-300 hover:text-white">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    <div id="heatmapContainer" class="grid grid-cols-7 gap-1">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-8 mb-8">
                <div class="xl:col-span-2 glass-card rounded-xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-white flex items-center">
                            <i class="fas fa-exclamation-triangle mr-3 text-red-400"></i>
                            Alertas & Diverg√™ncias
                        </h3>
                        <div class="flex space-x-2">
                            <button id="resolveAllBtn" class="bg-green-500 hover:bg-green-600 px-3 py-1 rounded text-white text-sm">
                                Resolver Todos
                            </button>
                            <button id="filterCriticalBtn" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-white text-sm">
                                Apenas Cr√≠ticos
                            </button>
                        </div>
                    </div>
                    <div id="alertsContainer" class="space-y-3 max-h-96 overflow-y-auto">
                    </div>
                </div>

                <div class="glass-card rounded-xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-white flex items-center">
                            <i class="fas fa-clock mr-3 text-blue-400"></i>
                            Turnos Ativos
                        </h3>
                        <button id="refreshTurnosBtn" class="text-gray-300 hover:text-white">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div id="turnosContainer" class="space-y-4">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8">
                <div class="glass-card rounded-xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-white flex items-center">
                            <i class="fas fa-history mr-3 text-indigo-400"></i>
                            Timeline de A√ß√µes
                        </h3>
                        <div class="flex space-x-2">
                            <input type="text" id="timelineSearch" placeholder="Buscar a√ß√µes..." class="glass-card text-white placeholder-gray-300 px-3 py-1 rounded text-sm border-none">
                            <button id="exportTimelineBtn" class="text-gray-300 hover:text-white">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                    <div id="timelineContainer" class="space-y-4 max-h-96 overflow-y-auto">
                    </div>
                </div>

                <div class="glass-card rounded-xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-white flex items-center">
                            <i class="fas fa-cogs mr-3 text-purple-400"></i>
                            A√ß√µes R√°pidas
                        </h3>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="managePricesBtn" class="glass-card p-4 rounded-lg text-white hover:bg-white hover:bg-opacity-10 transition-colors">
                            <i class="fas fa-tags text-2xl mb-2 text-orange-400"></i>
                            <p class="font-medium">Gerenciar Pre√ßos</p>
                        </button>
                        
                        <button id="manageUsersBtn" class="glass-card p-4 rounded-lg text-white hover:bg-white hover:bg-opacity-10 transition-colors">
                            <i class="fas fa-users text-2xl mb-2 text-blue-400"></i>
                            <p class="font-medium">Gerenciar Usu√°rios</p>
                        </button>
                        
                        <button id="transferCashBtn" class="glass-card p-4 rounded-lg text-white hover:bg-white hover:bg-opacity-10 transition-colors">
                            <i class="fas fa-exchange-alt text-2xl mb-2 text-green-400"></i>
                            <p class="font-medium">Transferir Caixa</p>
                        </button>
                        
                        <button id="generateReportBtn" class="glass-card p-4 rounded-lg text-white hover:bg-white hover:bg-opacity-10 transition-colors">
                            <i class="fas fa-file-alt text-2xl mb-2 text-purple-400"></i>
                            <p class="font-medium">Gerar Relat√≥rio</p>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="kpiModal" class="modal">
        <div class="modal-content w-full max-w-4xl p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 id="modalTitle" class="text-2xl font-bold text-gray-800"></h3>
                <button class="modal-close text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="modalContent" class="space-y-6">
            </div>
        </div>
    </div>

    <div id="pricesModal" class="modal">
        <div class="modal-content w-full max-w-6xl p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Gerenciar Pre√ßos dos Produtos</h3>
                <button class="modal-close text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="border rounded-lg p-4">
                        <h4 class="font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-utensils mr-2 text-orange-500"></i>Past√©is
                        </h4>
                        <div id="precosPasteisContainer" class="space-y-3">
                        </div>
                    </div>
                    
                    <div class="border rounded-lg p-4">
                        <h4 class="font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-ice-cream mr-2 text-blue-500"></i>Casquinhas
                        </h4>
                        <div id="precosCasquinhasContainer" class="space-y-3">
                        </div>
                    </div>
                    
                    <div class="border rounded-lg p-4">
                        <h4 class="font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-glass-whiskey mr-2 text-green-500"></i>Caldo de Cana
                        </h4>
                        <div id="precosCaldoCanaContainer" class="space-y-3">
                        </div>
                    </div>
                    
                    <div class="border rounded-lg p-4">
                        <h4 class="font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-bottle-water mr-2 text-purple-500"></i>Refrigerantes
                        </h4>
                        <div id="precosRefrigerantesContainer" class="space-y-3">
                        </div>
                    </div>
                    
                    <div class="border rounded-lg p-4">
                        <h4 class="font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-cube mr-2 text-gray-500"></i>Gelo
                        </h4>
                        <div id="precosGeloContainer" class="space-y-3">
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4">
                    <button class="modal-close px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button id="savePricesBtn" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg">
                        Salvar Altera√ß√µes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="usersModal" class="modal">
        <div class="modal-content w-full max-w-4xl p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Gerenciar Usu√°rios</h3>
                <button class="modal-close text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="space-y-6">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-800 mb-4">Adicionar Novo Usu√°rio</h4>
                    <form id="formNovoUsuario" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">UID (Firebase Auth)</label>
                            <input type="text" id="novoUsuarioUid" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="UID do Firebase Console">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nome Completo</label>
                            <input type="text" id="novoUsuarioNome" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Nome do Funcion√°rio">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="novoUsuarioEmail" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="email@example.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fun√ß√£o</label>
                            <select id="novoUsuarioRole" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="funcionario">Funcion√°rio</option>
                                <option value="admin">Administrador</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                                Adicionar Usu√°rio
                            </button>
                        </div>
                    </form>
                    <p id="usuarioMsg" class="text-sm mt-3 text-center font-medium"></p>
                </div>
                
                <div>
                    <h4 class="font-semibold text-gray-800 mb-4">Usu√°rios Existentes</h4>
                    <div id="listaUsuariosContainer" class="space-y-3">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="alertModal" class="modal">
        <div class="modal-content w-full max-w-2xl p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 id="alertModalTitle" class="text-xl font-bold text-gray-800"></h3>
                <button class="modal-close text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="alertModalContent" class="space-y-4">
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button class="modal-close px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancelar
                </button>
                <button id="resolveAlertBtn" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg">
                    Resolver
                </button>
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script src="src/js/firebase-config.js"></script>
    <script src="src/js/shared.js"></script>
    <script src="src/js/auth.js"></script>
    <script>
        class ModernAdminDashboard {
            constructor() {
                this.currentPeriod = 'today';
                this.activeFilters = {};
                this.dashboardData = {};
                this.charts = {};
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.initializeCharts();
                this.loadDashboardData();
                this.startRealTimeUpdates();
            }

            setupEventListeners() {
                document.getElementById('periodSelector').addEventListener('change', (e) => {
                    this.currentPeriod = e.target.value;
                    this.toggleCustomDateRange();
                    this.loadDashboardData();
                });

                document.getElementById('refreshData').addEventListener('click', () => {
                    this.loadDashboardData();
                    this.showToast('Dados atualizados com sucesso!', 'success');
                });

                document.querySelectorAll('.kpi-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const kpiType = card.dataset.kpi;
                        this.showKPIDetails(kpiType);
                    });
                });

                document.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.addEventListener('click', () => {
                        chip.classList.toggle('active');
                        this.updateFilters();
                    });
                });

                document.getElementById('managePricesBtn').addEventListener('click', () => {
                    this.showPricesModal();
                });

                document.getElementById('manageUsersBtn').addEventListener('click', () => {
                    this.showUsersModal();
                });

                document.querySelectorAll('.modal-close').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.closeModal(e.target.closest('.modal'));
                    });
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeAllModals();
                    }
                });
            }

            toggleCustomDateRange() {
                const customRange = document.getElementById('customDateRange');
                if (this.currentPeriod === 'custom') {
                    customRange.classList.remove('hidden');
                } else {
                    customRange.classList.add('hidden');
                }
            }

            async loadDashboardData() {
                try {
                    const dateRange = this.getDateRange();
                    const turnos = await this.fetchTurnos(dateRange);
                    
                    this.dashboardData = this.processData(turnos);
                    this.updateKPICards();
                    this.updateCharts();
                    this.updateAlerts();
                    this.updateTurnos();
                    this.updateTimeline();
                } catch (error) {
                    console.error('Erro ao carregar dados:', error);
                    this.showToast('Erro ao carregar dados do dashboard', 'error');
                }
            }

            getDateRange() {
                const now = new Date();
                let startDate, endDate;

                switch (this.currentPeriod) {
                    case 'today':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                        break;
                    case 'yesterday':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
                        endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        break;
                    case 'week':
                        const weekStart = new Date(now);
                        weekStart.setDate(now.getDate() - now.getDay());
                        startDate = new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate());
                        endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                        break;
                    case 'custom':
                        const startInput = document.getElementById('startDate').value;
                        const endInput = document.getElementById('endDate').value;
                        startDate = startInput ? new Date(startInput) : new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        endDate = endInput ? new Date(endInput) : new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                        break;
                    default:
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                }

                return { startDate, endDate };
            }

            async fetchTurnos(dateRange) {
                try {
                    const startDateId = this.formatDateForId(dateRange.startDate);
                    const endDateId = this.formatDateForId(dateRange.endDate);
                    
                    let query = db.collection('turnos')
                        .where('status', '==', 'fechado')
                        .orderBy(firebase.firestore.FieldPath.documentId());
                    
                    if (startDateId === endDateId) {
                        query = query.startAt(`${startDateId}_Manh√£`).endAt(`${startDateId}_Noite`);
                    } else {
                        query = query.startAt(`${startDateId}_Manh√£`).endAt(`${endDateId}_Noite`);
                    }

                    const snapshot = await query.get();
                    const turnos = [];
                    snapshot.forEach(doc => {
                        turnos.push({ id: doc.id, ...doc.data() });
                    });

                    return turnos;
                } catch (error) {
                    console.error('Erro ao buscar turnos:', error);
                    return [];
                }
            }

            formatDateForId(date) {
                return date.toISOString().split('T')[0];
            }

            processData(turnos) {
                const data = {
                    vendas: 0,
                    totalPedidos: 0,
                    divergencias: [],
                    formasPagamento: {},
                    produtos: {},
                    vendasPorHora: {},
                    caixaAtual: 0,
                    lucroEstimado: 0
                };

                turnos.forEach(turno => {
                    if (turno.totalVendidoCalculadoFinal) {
                        data.vendas += turno.totalVendidoCalculadoFinal;
                    }

                    data.totalPedidos += this.contarPedidosTurno(turno);

                    if (turno.formasPagamento) {
                        Object.entries(turno.formasPagamento).forEach(([forma, valor]) => {
                            data.formasPagamento[forma] = (data.formasPagamento[forma] || 0) + valor;
                        });
                    }

                    if (turno.itens) {
                        Object.values(turno.itens).forEach(categoria => {
                            Object.entries(categoria).forEach(([produto, info]) => {
                                if (info.vendido > 0) {
                                    data.produtos[produto] = (data.produtos[produto] || 0) + info.vendido;
                                }
                            });
                        });
                    }

                    if (this.hasDivergencia(turno)) {
                        data.divergencias.push(turno);
                    }

                    if (turno.caixaFinalContado) {
                        data.caixaAtual = turno.caixaFinalContado;
                    }
                });

                data.ticketMedio = data.totalPedidos > 0 ? data.vendas / data.totalPedidos : 0;
                data.percentualDivergencias = turnos.length > 0 ? (data.divergencias.length / turnos.length) * 100 : 0;
                data.lucroEstimado = data.vendas * 0.35;

                return data;
            }

            contarPedidosTurno(turno) {
                let total = 0;
                if (turno.itens) {
                    Object.values(turno.itens).forEach(categoria => {
                        Object.values(categoria).forEach(item => {
                            if (item.vendido > 0) {
                                total += item.vendido;
                            }
                        });
                    });
                }
                return total;
            }

            hasDivergencia(turno) {
                const vendidoCalc = turno.totalVendidoCalculadoFinal || 0;
                const pagamentosReg = turno.totalRegistradoPagamentosFinal || 0;
                const diffCaixa = turno.diferencaCaixaFinal || 0;
                
                return Math.abs(vendidoCalc - pagamentosReg) > 0.01 || Math.abs(diffCaixa) > 0.01;
            }

            updateKPICards() {
                const formatter = new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                });

                document.getElementById('kpi-vendas').textContent = formatter.format(this.dashboardData.vendas);
                document.getElementById('kpi-ticket').textContent = formatter.format(this.dashboardData.ticketMedio);
                document.getElementById('kpi-pedidos').textContent = this.dashboardData.totalPedidos.toString();
                document.getElementById('kpi-divergencias').textContent = `${this.dashboardData.percentualDivergencias.toFixed(1)}%`;
                document.getElementById('kpi-caixa').textContent = formatter.format(this.dashboardData.caixaAtual);
                document.getElementById('kpi-lucro').textContent = formatter.format(this.dashboardData.lucroEstimado);
            }

            initializeCharts() {
                const chartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                };

                this.charts.payment = new Chart(document.getElementById('paymentChart'), {
                    type: 'pie',
                    data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
                    options: { ...chartOptions, scales: undefined }
                });

                this.charts.products = new Chart(document.getElementById('productsChart'), {
                    type: 'bar',
                    data: { labels: [], datasets: [{ data: [], backgroundColor: '#3b82f6' }] },
                    options: { ...chartOptions, indexAxis: 'y' }
                });

                this.charts.sales = new Chart(document.getElementById('salesChart'), {
                    type: 'line',
                    data: { labels: [], datasets: [{ data: [], borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)' }] },
                    options: chartOptions
                });
            }

            updateCharts() {
                this.updatePaymentChart();
                this.updateProductsChart();
                this.updateSalesChart();
                this.updateHeatmap();
            }

            updatePaymentChart() {
                const data = Object.entries(this.dashboardData.formasPagamento);
                const labels = data.map(([key]) => this.formatPaymentMethod(key));
                const values = data.map(([, value]) => value);
                const colors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6'];

                this.charts.payment.data.labels = labels;
                this.charts.payment.data.datasets[0].data = values;
                this.charts.payment.data.datasets[0].backgroundColor = colors.slice(0, labels.length);
                this.charts.payment.update();
            }

            updateProductsChart() {
                const sorted = Object.entries(this.dashboardData.produtos)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 10);

                this.charts.products.data.labels = sorted.map(([name]) => this.formatProductName(name));
                this.charts.products.data.datasets[0].data = sorted.map(([, qty]) => qty);
                this.charts.products.update();
            }

            updateSalesChart() {
                const hours = Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`);
                const salesData = hours.map(() => Math.random() * 1000);

                this.charts.sales.data.labels = hours;
                this.charts.sales.data.datasets[0].data = salesData;
                this.charts.sales.update();
            }

            updateHeatmap() {
                const container = document.getElementById('heatmapContainer');
                container.innerHTML = '';

                const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
                const shifts = ['Manh√£', 'Tarde', 'Noite'];

                days.forEach(day => {
                    shifts.forEach(shift => {
                        const cell = document.createElement('div');
                        const intensity = Math.random();
                        cell.className = `h-8 rounded text-xs flex items-center justify-center text-white font-medium`;
                        cell.style.backgroundColor = `rgba(239, 68, 68, ${intensity})`;
                        cell.textContent = Math.floor(intensity * 10);
                        cell.title = `${day} - ${shift}: ${Math.floor(intensity * 10)} diverg√™ncias`;
                        container.appendChild(cell);
                    });
                });
            }

            updateAlerts() {
                const container = document.getElementById('alertsContainer');
                container.innerHTML = '';

                this.dashboardData.divergencias.forEach(turno => {
                    const alert = this.createAlertElement(turno);
                    container.appendChild(alert);
                });

                if (this.dashboardData.divergencias.length === 0) {
                    container.innerHTML = '<p class="text-gray-300 text-center py-8">Nenhuma diverg√™ncia encontrada üéâ</p>';
                }
            }

            createAlertElement(turno) {
                const div = document.createElement('div');
                const severity = this.getAlertSeverity(turno);
                div.className = `p-4 rounded-lg border-l-4 ${severity === 'critical' ? 'severity-critical' : 'severity-warning'}`;

                const vendidoCalc = turno.totalVendidoCalculadoFinal || 0;
                const pagamentosReg = turno.totalRegistradoPagamentosFinal || 0;
                const diffVendas = vendidoCalc - pagamentosReg;
                const diffCaixa = turno.diferencaCaixaFinal || 0;

                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-semibold text-gray-800">Turno ${turno.id}</h4>
                            <p class="text-sm text-gray-600">Respons√°vel: ${turno.fechamento?.responsavelNome || 'N/A'}</p>
                            ${Math.abs(diffVendas) > 0.01 ? `<p class="text-sm">Diferen√ßa vendas/pagamentos: ${this.formatCurrency(Math.abs(diffVendas))}</p>` : ''}
                            ${Math.abs(diffCaixa) > 0.01 ? `<p class="text-sm">Diferen√ßa caixa: ${this.formatCurrency(Math.abs(diffCaixa))}</p>` : ''}
                        </div>
                        <div class="flex space-x-2">
                            <button class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600" onclick="dashboard.showAlertDetails('${turno.id}')">
                                Detalhes
                            </button>
                            <button class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600" onclick="dashboard.resolveAlert('${turno.id}')">
                                Resolver
                            </button>
                        </div>
                    </div>
                `;

                return div;
            }

            getAlertSeverity(turno) {
                const vendidoCalc = turno.totalVendidoCalculadoFinal || 0;
                const pagamentosReg = turno.totalRegistradoPagamentosFinal || 0;
                const diffVendas = Math.abs(vendidoCalc - pagamentosReg);
                const diffCaixa = Math.abs(turno.diferencaCaixaFinal || 0);

                return (diffVendas > 50 || diffCaixa > 50) ? 'critical' : 'warning';
            }

            updateTurnos() {
                const container = document.getElementById('turnosContainer');
                container.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-green-100 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                <div>
                                    <p class="font-medium text-green-800">Turno Manh√£</p>
                                    <p class="text-sm text-green-600">Jo√£o Silva</p>
                                </div>
                            </div>
                            <button class="text-green-600 hover:text-green-800">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        
                        <div class="flex items-center justify-between p-3 bg-yellow-100 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></div>
                                <div>
                                    <p class="font-medium text-yellow-800">Turno Tarde</p>
                                    <p class="text-sm text-yellow-600">Em andamento</p>
                                </div>
                            </div>
                            <button class="text-yellow-600 hover:text-yellow-800">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
            }

            updateTimeline() {
                const container = document.getElementById('timelineContainer');
                const actions = [
                    { time: '14:30', action: 'Turno Tarde iniciado', user: 'Maria Santos', type: 'info' },
                    { time: '13:45', action: 'Turno Manh√£ fechado', user: 'Jo√£o Silva', type: 'success' },
                    { time: '13:40', action: 'Diverg√™ncia de R$ 15,00 resolvida', user: 'Jo√£o Silva', type: 'warning' },
                    { time: '12:15', action: 'Pre√ßos atualizados', user: 'Admin', type: 'info' },
                    { time: '08:30', action: 'Caixa transferido: R$ 250,00', user: 'Jo√£o Silva', type: 'success' }
                ];

                container.innerHTML = actions.map(action => `
                    <div class="timeline-item">
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="font-medium text-white">${action.action}</p>
                                <p class="text-sm text-gray-300">${action.user} ‚Ä¢ ${action.time}</p>
                            </div>
                            <i class="fas fa-${action.type === 'success' ? 'check' : action.type === 'warning' ? 'exclamation-triangle' : 'info-circle'} text-${action.type === 'success' ? 'green' : action.type === 'warning' ? 'yellow' : 'blue'}-400"></i>
                        </div>
                    </div>
                `).join('');
            }

            showKPIDetails(kpiType) {
                const modal = document.getElementById('kpiModal');
                const title = document.getElementById('modalTitle');
                const content = document.getElementById('modalContent');

                const titles = {
                    vendas: 'Detalhamento de Vendas',
                    ticket: 'An√°lise do Ticket M√©dio',
                    pedidos: 'Total de Pedidos',
                    divergencias: 'An√°lise de Diverg√™ncias',
                    caixa: 'Status do Caixa',
                    lucro: 'Proje√ß√£o de Lucro'
                };

                title.textContent = titles[kpiType] || 'Detalhes';
                content.innerHTML = this.generateKPIContent(kpiType);
                this.showModal(modal);
            }

            generateKPIContent(kpiType) {
                const formatter = new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                });

                switch (kpiType) {
                    case 'vendas':
                        return `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <h4 class="font-semibold text-gray-800">Resumo de Vendas</h4>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span>Vendas Brutas:</span>
                                            <span class="font-semibold">${formatter.format(this.dashboardData.vendas)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Descontos:</span>
                                            <span class="font-semibold">R$ 0,00</span>
                                        </div>
                                        <div class="flex justify-between border-t pt-2">
                                            <span class="font-semibold">Total L√≠quido:</span>
                                            <span class="font-bold">${formatter.format(this.dashboardData.vendas)}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <h4 class="font-semibold text-gray-800">Comparativo</h4>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span>Ontem:</span>
                                            <span class="text-green-600">+12.5%</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Semana Passada:</span>
                                            <span class="text-green-600">+8.3%</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>M√™s Passado:</span>
                                            <span class="text-green-600">+15.7%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    default:
                        return `<p class="text-gray-600">Detalhes detalhados para ${kpiType} ser√£o implementados em breve.</p>`;
                }
            }

            async showPricesModal() {
                const modal = document.getElementById('pricesModal');
                await this.loadPrices();
                this.showModal(modal);
            }

            async loadPrices() {
                try {
                    const snapshot = await db.collection('produtos').get();
                    const prices = {};
                    snapshot.forEach(doc => {
                        prices[doc.id] = doc.data();
                    });

                    this.populatePriceContainers(prices);
                } catch (error) {
                    console.error('Erro ao carregar pre√ßos:', error);
                    this.showToast('Erro ao carregar pre√ßos', 'error');
                }
            }

            populatePriceContainers(prices) {
                const categories = {
                    pasteis: { container: 'precosPasteisContainer', items: listaSaboresPasteis },
                    casquinhas: { container: 'precosCasquinhasContainer', items: listaCasquinhas },
                    caldo_cana: { container: 'precosCaldoCanaContainer', items: listaCaldoCana },
                    refrigerantes: { container: 'precosRefrigerantesContainer', items: listaRefrigerantes },
                    gelo: { container: 'precosGeloContainer', items: ['Gelo (Pacote)'] }
                };

                Object.entries(categories).forEach(([categoryKey, { container, items }]) => {
                    const containerEl = document.getElementById(container);
                    containerEl.innerHTML = '';

                    items.forEach(item => {
                        const key = this.generateItemKey(item);
                        const price = prices[categoryKey]?.[key]?.preco || 0;

                        const div = document.createElement('div');
                        div.className = 'flex items-center justify-between';
                        div.innerHTML = `
                            <label class="text-sm font-medium text-gray-700">${item}</label>
                            <input type="number" 
                                   step="0.01" 
                                   min="0" 
                                   value="${price.toFixed(2)}"
                                   data-category="${categoryKey}"
                                   data-item="${key}"
                                   class="w-20 px-2 py-1 border border-gray-300 rounded text-sm focus:ring-blue-500 focus:border-blue-500">
                        `;
                        containerEl.appendChild(div);
                    });
                });

                document.getElementById('savePricesBtn').onclick = () => this.savePrices();
            }

            generateItemKey(item) {
                return item.toLowerCase()
                    .replace(/\s+/g, '_')
                    .replace(/[√ß√á]/g, 'c')
                    .replace(/[√£√¢√°√†√§√É√Ç√Å√Ä√Ñ]/g, 'a')
                    .replace(/[√©√™√®√´√â√ä√à√ã]/g, 'e')
                    .replace(/[√≠√¨√Æ√Ø√ç√å√é√è]/g, 'i')
                    .replace(/[√≥√¥√µ√≤√∂√ì√î√ï√í√ñ]/g, 'o')
                    .replace(/[√∫√π√ª√º√ö√ô√õ√ú]/g, 'u')
                    .replace(/[\.]/g, '');
            }

            async savePrices() {
                try {
                    const inputs = document.querySelectorAll('#pricesModal input[data-category]');
                    const priceUpdates = {};

                    inputs.forEach(input => {
                        const category = input.dataset.category;
                        const item = input.dataset.item;
                        const price = parseFloat(input.value) || 0;

                        if (!priceUpdates[category]) {
                            priceUpdates[category] = {};
                        }
                        priceUpdates[category][item] = { preco: price };
                    });

                    const batch = db.batch();
                    Object.entries(priceUpdates).forEach(([category, items]) => {
                        const docRef = db.collection('produtos').doc(category);
                        batch.set(docRef, items, { merge: true });
                    });

                    await batch.commit();
                    this.showToast('Pre√ßos atualizados com sucesso!', 'success');
                    this.closeModal(document.getElementById('pricesModal'));
                } catch (error) {
                    console.error('Erro ao salvar pre√ßos:', error);
                    this.showToast('Erro ao salvar pre√ßos', 'error');
                }
            }

            async showUsersModal() {
                const modal = document.getElementById('usersModal');
                await this.loadUsers();
                this.showModal(modal);

                document.getElementById('formNovoUsuario').onsubmit = (e) => {
                    e.preventDefault();
                    this.addUser();
                };
            }

            async loadUsers() {
                try {
                    const snapshot = await db.collection('usuarios').get();
                    const container = document.getElementById('listaUsuariosContainer');
                    container.innerHTML = '';

                    if (snapshot.empty) {
                        container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum usu√°rio cadastrado</p>';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const user = doc.data();
                        const div = document.createElement('div');
                        div.className = 'flex items-center justify-between p-4 border rounded-lg';
                        div.innerHTML = `
                            <div>
                                <p class="font-semibold text-gray-800">${user.nome || 'Sem nome'}</p>
                                <p class="text-sm text-gray-600">${user.email || 'Sem email'}</p>
                                <p class="text-xs text-gray-500">UID: ${doc.id}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <select class="px-2 py-1 border rounded text-sm" onchange="dashboard.updateUserRole('${doc.id}', this.value)">
                                    <option value="funcionario" ${user.role === 'funcionario' ? 'selected' : ''}>Funcion√°rio</option>
                                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                </select>
                                <button onclick="dashboard.deleteUser('${doc.id}')" class="px-2 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                } catch (error) {
                    console.error('Erro ao carregar usu√°rios:', error);
                    this.showToast('Erro ao carregar usu√°rios', 'error');
                }
            }

            async addUser() {
                try {
                    const uid = document.getElementById('novoUsuarioUid').value.trim();
                    const nome = document.getElementById('novoUsuarioNome').value.trim();
                    const email = document.getElementById('novoUsuarioEmail').value.trim();
                    const role = document.getElementById('novoUsuarioRole').value;

                    if (!uid || !nome || !email) {
                        this.showToast('Preencha todos os campos obrigat√≥rios', 'error');
                        return;
                    }

                    await db.collection('usuarios').doc(uid).set({
                        nome,
                        email,
                        role,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    this.showToast('Usu√°rio adicionado com sucesso!', 'success');
                    document.getElementById('formNovoUsuario').reset();
                    this.loadUsers();
                } catch (error) {
                    console.error('Erro ao adicionar usu√°rio:', error);
                    this.showToast('Erro ao adicionar usu√°rio', 'error');
                }
            }

            async updateUserRole(uid, newRole) {
                try {
                    await db.collection('usuarios').doc(uid).update({ role: newRole });
                    this.showToast('Fun√ß√£o do usu√°rio atualizada!', 'success');
                } catch (error) {
                    console.error('Erro ao atualizar fun√ß√£o:', error);
                    this.showToast('Erro ao atualizar fun√ß√£o do usu√°rio', 'error');
                }
            }

            async deleteUser(uid) {
                if (!confirm('Tem certeza que deseja excluir este usu√°rio?')) return;

                try {
                    await db.collection('usuarios').doc(uid).delete();
                    this.showToast('Usu√°rio exclu√≠do com sucesso!', 'success');
                    this.loadUsers();
                } catch (error) {
                    console.error('Erro ao excluir usu√°rio:', error);
                    this.showToast('Erro ao excluir usu√°rio', 'error');
                }
            }

            showAlertDetails(turnoId) {
                const modal = document.getElementById('alertModal');
                document.getElementById('alertModalTitle').textContent = `Detalhes - Turno ${turnoId}`;
                document.getElementById('alertModalContent').innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">Hist√≥rico de Diverg√™ncias</h4>
                            <div class="bg-gray-50 p-3 rounded">
                                <p class="text-sm text-gray-600">Nenhuma a√ß√£o anterior registrada para este turno.</p>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Justificativa para Resolu√ß√£o</label>
                            <textarea id="resolveJustification" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="Descreva a justificativa para resolver esta diverg√™ncia..."></textarea>
                        </div>
                    </div>
                `;
                document.getElementById('resolveAlertBtn').onclick = () => this.resolveAlert(turnoId);
                this.showModal(modal);
            }

            resolveAlert(turnoId) {
                const justification = document.getElementById('resolveJustification')?.value || 'Resolvido pelo administrador';
                
                // Aqui voc√™ salvaria a resolu√ß√£o no banco de dados
                this.showToast(`Diverg√™ncia do turno ${turnoId} foi resolvida!`, 'success');
                this.closeAllModals();
                this.loadDashboardData();
            }

            showModal(modal) {
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
            }

            closeModal(modal) {
                modal.classList.remove('show');
                document.body.style.overflow = 'auto';
            }

            closeAllModals() {
                document.querySelectorAll('.modal').forEach(modal => {
                    this.closeModal(modal);
                });
            }

            showToast(message, type = 'info') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-blue-500'
                };

                const icons = {
                    success: 'check-circle',
                    error: 'exclamation-circle',
                    warning: 'exclamation-triangle',
                    info: 'info-circle'
                };

                toast.className = `toast ${colors[type]} text-white p-4 rounded-lg shadow-lg flex items-center space-x-3`;
                toast.innerHTML = `
                    <i class="fas fa-${icons[type]}"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.remove()" class="ml-auto">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 5000);
            }

            formatCurrency(value) {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            }

            formatPaymentMethod(method) {
                const methods = {
                    dinheiro: 'Dinheiro',
                    pixManual: 'PIX Manual',
                    stoneDCV: 'Stone D/C/V',
                    stoneVoucher: 'Stone Voucher',
                    pagbankDCV: 'PagBank D/C/V'
                };
                return methods[method] || method;
            }

            formatProductName(key) {
                return key.replace(/_/g, ' ')
                    .replace(/\b\w/g, l => l.toUpperCase());
            }

            startRealTimeUpdates() {
                setInterval(() => {
                    this.checkForNewAlerts();
                }, 30000);
            }

            checkForNewAlerts() {
                // Simula√ß√£o de verifica√ß√£o de novos alertas
                if (Math.random() > 0.9) {
                    this.showToast('Nova diverg√™ncia detectada no Turno Tarde!', 'warning');
                    this.updateNotificationBadge();
                }
            }

            updateNotificationBadge() {
                const badge = document.getElementById('notificationBadge');
                const currentCount = parseInt(badge.textContent) || 0;
                badge.textContent = currentCount + 1;
                badge.classList.remove('hidden');
            }

            updateFilters() {
                const activeFilters = document.querySelectorAll('.filter-chip.active');
                this.activeFilters = {};
                
                activeFilters.forEach(filter => {
                    const filterType = filter.dataset.filter;
                    this.activeFilters[filterType] = true;
                });

                this.loadDashboardData();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            protectRoute(['admin']);
            window.dashboard = new ModernAdminDashboard();
        });
    </script>
</body>
</html>